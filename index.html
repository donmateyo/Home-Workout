<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>KB·DB Coach</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#0b1022" media="(prefers-color-scheme: dark)">
  <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
  <meta name="description" content="Single-file kettlebell & dumbbell coach for 25s, 35s, 50, 70. Tracks sets, timers, and progress. PWA with custom iOS icon." />

  <style>
    :root {
      --bg: #0d1020;
      --bg2: #121632;
      --card: #171c3a;
      --text: #e9eefc;
      --muted: #9aa5d1;
      --accent: #5f8cff;
      --accent2: #86ffd9;
      --danger: #ff6b6b;
      --ok: #63d391;
      --shadow: 0 8px 24px rgba(0,0,0,0.3);
      --radius: 16px;
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f7f9ff;
        --bg2: #eef2ff;
        --card: #ffffff;
        --text: #0e1338;
        --muted: #5c6aa6;
        --accent: #3756ff;
        --accent2: #00bfa6;
        --danger: #d93025;
        --ok: #2e7d32;
        --shadow: 0 8px 24px rgba(0,0,0,0.08);
      }
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
      color: var(--text);
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", Segoe UI, Roboto, Helvetica, Arial, system-ui, "Apple Color Emoji", "Segoe UI Emoji";
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }

    .app {
      min-height: 100dvh;
      display: grid;
      grid-template-rows: auto 1fr auto;
    }

    header.appbar {
      position: sticky;
      top: 0;
      z-index: 3;
      padding: calc(env(safe-area-inset-top) + 12px) 16px 12px 16px;
      backdrop-filter: saturate(180%) blur(10px);
      -webkit-backdrop-filter: saturate(180%) blur(10px);
      background: color-mix(in oklab, var(--bg) 70%, transparent);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      border-bottom: 1px solid color-mix(in oklab, var(--muted) 20%, transparent);
    }
    .app-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      letter-spacing: 0.2px;
      font-size: 18px;
    }
    .app-title .logo {
      width: 28px; height: 28px; border-radius: 8px; background: linear-gradient(135deg, #1b2355, #3163ff 70%); display: grid; place-items: center; box-shadow: var(--shadow);
    }
    .app-title .logo svg { width: 18px; height: 18px; fill: #fff; opacity: 0.92; }

    .app-actions {
      display: flex; gap: 10px;
    }
    .icon-btn {
      background: transparent; color: var(--text); border: 1px solid color-mix(in oklab, var(--muted) 30%, transparent);
      border-radius: 12px; padding: 8px 10px; display: inline-flex; align-items: center; gap: 8px; font-weight: 600; cursor: pointer;
    }
    .icon-btn:active { transform: translateY(1px); }
    .icon-btn.danger { color: var(--danger); border-color: color-mix(in oklab, var(--danger) 50%, transparent); }

    main {
      padding: 12px 16px calc(env(safe-area-inset-bottom) + 88px);
      display: grid; gap: 14px;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      border: 1px solid color-mix(in oklab, var(--muted) 18%, transparent);
    }
    .card h2 {
      font-size: 16px; margin: 0 0 8px; letter-spacing: 0.2px;
    }
    .card .sub { color: var(--muted); font-size: 13px; margin-bottom: 10px; }

    .grid-2 {
      display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
    }
    @media (max-width: 420px) {
      .grid-2 { grid-template-columns: 1fr; }
    }

    .field {
      display: grid; gap: 6px; font-size: 14px;
    }
    .field label { color: var(--muted); font-size: 12px; }
    .seg {
      display: inline-flex; border-radius: 12px; overflow: hidden; border: 1px solid color-mix(in oklab, var(--muted) 20%, transparent);
    }
    .seg button {
      padding: 8px 10px; background: transparent; color: var(--text); border: none; font-weight: 600; cursor: pointer; font-size: 13px;
      border-right: 1px solid color-mix(in oklab, var(--muted) 20%, transparent);
    }
    .seg button:last-child { border-right: none; }
    .seg button.active { background: color-mix(in oklab, var(--accent) 20%, transparent); color: #fff; }

    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 14px; border-radius: 14px; font-weight: 700; letter-spacing: 0.2px; cursor: pointer;
      border: none; color: #fff; background: linear-gradient(135deg, var(--accent), color-mix(in oklab, var(--accent2) 30%, var(--accent)));
      box-shadow: var(--shadow);
    }
    .btn.secondary { background: color-mix(in oklab, var(--accent) 20%, transparent); color: #fff; }
    .btn.ghost { background: transparent; color: var(--text); border: 1px solid color-mix(in oklab, var(--muted) 30%, transparent); }

    .row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .row.wrap { flex-wrap: wrap; }
    .muted { color: var(--muted); }
    .small { font-size: 12px; }

    .exercise {
      display: grid; gap: 8px; padding: 10px; border-radius: 12px; background: color-mix(in oklab, var(--card) 92%, transparent);
      border: 1px solid color-mix(in oklab, var(--muted) 20%, transparent);
    }
    .exercise h3 { margin: 0; font-size: 15px; }
    .tags { display: flex; gap: 8px; flex-wrap: wrap; }
    .tag { font-size: 11px; padding: 4px 7px; border-radius: 999px; color: #fff; background: color-mix(in oklab, var(--accent) 30%, var(--card)); border: 1px solid color-mix(in oklab, var(--muted) 25%, transparent); }
    .tag.grey { background: color-mix(in oklab, var(--muted) 30%, var(--card)); }
    .tag.green { background: color-mix(in oklab, var(--ok) 35%, var(--card)); }
    .tag.red { background: color-mix(in oklab, var(--danger) 30%, var(--card)); }

    .sets {
      display: grid; gap: 8px;
    }
    .set-row {
      display: grid; grid-template-columns: 36px 1fr 96px 90px 38px; gap: 8px; align-items: center;
    }
    @media (max-width: 420px) {
      .set-row { grid-template-columns: 28px 1fr 80px 78px 34px; }
    }
    .pill {
      border: 1px solid color-mix(in oklab, var(--muted) 25%, transparent); border-radius: 10px; padding: 8px 10px; background: color-mix(in oklab, var(--card) 85%, var(--bg));
    }
    input[type="number"], input[type="text"] {
      width: 100%; border: none; outline: none; background: transparent; color: var(--text); font: inherit;
    }
    select {
      width: 100%; background: transparent; border: none; color: var(--text); font: inherit; outline: none;
    }

    .rest-timer {
      display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; margin-top: 10px;
    }
    .progress {
      height: 10px; background: color-mix(in oklab, var(--muted) 15%, transparent); border-radius: 999px; overflow: hidden;
    }
    .progress > div {
      height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), color-mix(in oklab, var(--accent2) 40%, var(--accent)));
      transition: width 0.25s linear;
    }

    .toast {
      position: fixed; bottom: calc(env(safe-area-inset-bottom) + 80px); left: 50%; transform: translateX(-50%);
      background: color-mix(in oklab, var(--card) 92%, var(--bg)); color: var(--text);
      border: 1px solid color-mix(in oklab, var(--muted) 25%, transparent);
      padding: 10px 14px; border-radius: 12px; box-shadow: var(--shadow);
      display: none; z-index: 80; font-size: 13px;
    }

    nav.tabbar {
      position: fixed; bottom: 0; left: 0; right: 0;
      padding: 10px calc(env(safe-area-inset-right) + 10px) calc(env(safe-area-inset-bottom) + 10px) calc(env(safe-area-inset-left) + 10px);
      background: color-mix(in oklab, var(--bg) 70%, transparent);
      backdrop-filter: saturate(180%) blur(10px);
      -webkit-backdrop-filter: saturate(180%) blur(10px);
      border-top: 1px solid color-mix(in oklab, var(--muted) 20%, transparent);
      display: grid; grid-auto-flow: column; gap: 10px; z-index: 10;
    }
    nav.tabbar button {
      border: none; border-radius: 12px; padding: 10px; font-weight: 700; color: var(--muted); background: transparent;
    }
    nav.tabbar button.active {
      color: #fff; background: color-mix(in oklab, var(--accent) 20%, transparent);
    }

    details.hint summary {
      cursor: pointer; color: var(--muted); font-size: 13px; margin-bottom: 6px;
    }

    .kicker { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.7px; }

    /* A2HS tip bubble */
    .a2hs-tip {
      position: fixed; inset: auto 10px calc(env(safe-area-inset-bottom) + 92px) 10px; z-index: 20;
      background: color-mix(in oklab, var(--card) 92%, var(--bg)); border: 1px solid color-mix(in oklab, var(--muted) 25%, transparent);
      color: var(--text); padding: 12px; border-radius: 14px; box-shadow: var(--shadow); display: none;
    }
    .a2hs-tip .row { align-items: flex-start; }
    .a2hs-tip .btn { padding: 8px 10px; font-size: 13px; }
  </style>

  <script>
    // Early: Generate custom icons (kettlebell + dumbbell) and attach apple-touch-icon and manifest.
    (function generateIconsAndManifest() {
      try {
        const sizes = [180, 192, 256, 512];
        const iconMap = new Map();

        function drawIcon(size) {
          const c = document.createElement('canvas');
          c.width = c.height = size;
          const ctx = c.getContext('2d');

          // Rounded rect mask
          const r = Math.round(size * 0.2);
          ctx.beginPath();
          ctx.moveTo(r, 0);
          ctx.arcTo(size, 0, size, size, r);
          ctx.arcTo(size, size, 0, size, r);
          ctx.arcTo(0, size, 0, 0, r);
          ctx.arcTo(0, 0, size, 0, r);
          ctx.closePath();
          ctx.save();
          ctx.clip();

          // BG gradient
          const g = ctx.createLinearGradient(0, 0, size, size);
          g.addColorStop(0, '#131b49');
          g.addColorStop(1, '#2f63ff');
          ctx.fillStyle = g;
          ctx.fillRect(0, 0, size, size);

          // Subtle noise
          try {
            const noise = document.createElement('canvas');
            noise.width = noise.height = 64;
            const nctx = noise.getContext('2d');
            const imgData = nctx.createImageData(64, 64);
            for (let i = 0; i < imgData.data.length; i += 4) {
              const v = Math.random() * 12;
              imgData.data[i] = 255;
              imgData.data[i+1] = 255;
              imgData.data[i+2] = 255;
              imgData.data[i+3] = v;
            }
            nctx.putImageData(imgData, 0, 0);
            const pattern = ctx.createPattern(noise, 'repeat');
            ctx.globalAlpha = 0.3;
            ctx.fillStyle = pattern;
            ctx.fillRect(0, 0, size, size);
            ctx.globalAlpha = 1;
          } catch {}

          // Kettlebell silhouette
          const cx = size * 0.39;
          const cy = size * 0.48;
          const scale = size / 180;

          ctx.save();
          ctx.translate(cx, cy);
          ctx.scale(scale, scale);

          // Glow
          ctx.shadowColor = 'rgba(0,0,0,0.35)';
          ctx.shadowBlur = 14 * scale;

          ctx.fillStyle = '#ffffff';
          ctx.strokeStyle = 'rgba(255,255,255,0.95)';
          ctx.lineWidth = 5;

          // Handle
          ctx.beginPath();
          ctx.moveTo(-28, -32);
          ctx.quadraticCurveTo(-48, -36, -50, -16);
          ctx.quadraticCurveTo(-50, 2, -34, 8);
          ctx.lineTo(-28, 8);
          ctx.quadraticCurveTo(-26, -4, -18, -12);
          ctx.quadraticCurveTo(-10, -20, 0, -20);
          ctx.quadraticCurveTo(10, -20, 18, -12);
          ctx.quadraticCurveTo(26, -4, 28, 8);
          ctx.lineTo(34, 8);
          ctx.quadraticCurveTo(50, 2, 50, -16);
          ctx.quadraticCurveTo(48, -36, 28, -32);
          ctx.closePath();
          ctx.fill();

          // Body
          ctx.beginPath();
          ctx.moveTo(-45, 8);
          ctx.quadraticCurveTo(-64, 20, -60, 50);
          ctx.quadraticCurveTo(-56, 86, 0, 90);
          ctx.quadraticCurveTo(56, 86, 60, 50);
          ctx.quadraticCurveTo(64, 20, 45, 8);
          ctx.closePath();
          ctx.fill();

          ctx.restore();

          // Dumbbell diagonal
          ctx.save();
          ctx.translate(size * 0.56, size * 0.56);
          ctx.rotate(-25 * Math.PI/180);
          const plate = size * 0.11;
          const barW = size * 0.46;
          const barH = size * 0.08;

          // bar
          ctx.fillStyle = 'white';
          ctx.shadowColor = 'rgba(0,0,0,0.35)';
          ctx.shadowBlur = 14;
          ctx.fillRect(-barW/2, -barH/2, barW, barH);

          // plates
          const pr = size * 0.12;
          const rr = 10 * (size / 180);
          function roundRect(x, y, w, h, r) {
            ctx.beginPath();
            ctx.moveTo(x + r, y);
            ctx.arcTo(x + w, y, x + w, y + h, r);
            ctx.arcTo(x + w, y + h, x, y + h, r);
            ctx.arcTo(x, y + h, x, y, r);
            ctx.arcTo(x, y, x + w, y, r);
            ctx.closePath();
          }
          ctx.fillStyle = '#ffffff';
          roundRect(-barW/2 - pr, -plate/2, pr, plate, rr);
          ctx.fill();
          roundRect(barW/2, -plate/2, pr, plate, rr);
          ctx.fill();
          ctx.restore();

          // "KB·DB" label
          ctx.save();
          ctx.fillStyle = 'rgba(255,255,255,0.96)';
          ctx.font = `bold ${Math.round(size*0.15)}px -apple-system, BlinkMacSystemFont, "SF Pro Display", ui-sans-serif`;
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.shadowColor = 'rgba(0,0,0,0.35)';
          ctx.shadowBlur = 8;
          ctx.fillText('KB·DB', size/2, size*0.86);
          ctx.restore();

          // Outer stroke (subtle)
          ctx.save();
          ctx.lineWidth = Math.max(2, size * 0.015);
          ctx.strokeStyle = 'rgba(255,255,255,0.15)';
          ctx.beginPath();
          const rr2 = Math.round(size * 0.2);
          ctx.moveTo(rr2, 2);
          ctx.arcTo(size-2, 2, size-2, size-2, rr2);
          ctx.arcTo(size-2, size-2, 2, size-2, rr2);
          ctx.arcTo(2, size-2, 2, 2, rr2);
          ctx.stroke();
          ctx.restore();

          return c.toDataURL('image/png');
        }

        sizes.forEach(sz => iconMap.set(sz, drawIcon(sz)));

        // Attach apple-touch-icon (iOS uses these)
        for (const [sz, url] of iconMap.entries()) {
          const link = document.createElement('link');
          link.rel = 'apple-touch-icon';
          link.sizes = `${sz}x${sz}`;
          link.href = url;
          document.head.appendChild(link);
        }
        // Favicon
        const fav = document.createElement('link');
        fav.rel = 'icon';
        fav.type = 'image/png';
        fav.href = iconMap.get(192);
        document.head.appendChild(fav);

        // Manifest (data URL, single-file)
        const icons = Array.from(iconMap.entries()).map(([sz, url]) => ({
          src: url, sizes: `${sz}x${sz}`, type: 'image/png', purpose: 'any maskable'
        }));
        const manifest = {
          name: 'KB·DB Coach',
          short_name: 'KB·DB',
          description: 'Single-file kettlebell & dumbbell coach tailored to 25s, 35s, 50, 70.',
          display: 'standalone',
          background_color: '#0b1022',
          theme_color: '#0b1022',
          start_url: '.',
          icons
        };
        const mlink = document.createElement('link');
        mlink.rel = 'manifest';
        mlink.href = 'data:application/manifest+json,' + encodeURIComponent(JSON.stringify(manifest));
        document.head.appendChild(mlink);
      } catch (e) {
        console.warn('Icon/manifest generation failed', e);
      }
    })();
  </script>
</head>
<body>
  <div class="app">
    <header class="appbar">
      <div class="app-title">
        <div class="logo" aria-hidden="true">
          <svg viewBox="0 0 24 24">
            <path d="M14.5 6.5c.8 0 1.5.7 1.5 1.5v1.5c2 .5 3.5 2.3 3.5 4.5 0 2.6-2.1 4.7-4.7 4.7h-5.6C6.7 18.7 4.6 16.6 4.6 14c0-2.2 1.5-4 3.5-4.5V8c0-.8.7-1.5 1.5-1.5h4.9zM3 12h1.2M19.8 12H21M7 4.6l.8 1.1M16.2 5.7l.8-1.1" fill="currentColor"/>
          </svg>
        </div>
        KB·DB Coach
      </div>
      <div class="app-actions">
        <button class="icon-btn" id="btnToday">Today</button>
        <button class="icon-btn" id="btnSettings">Settings</button>
      </div>
    </header>

    <main id="view">
      <!-- Dynamic content injected by JS -->
    </main>

    <nav class="tabbar" role="tablist" aria-label="Navigation">
      <button data-tab="plan" class="active" aria-selected="true">Plan</button>
      <button data-tab="workout">Workout</button>
      <button data-tab="history">History</button>
    </nav>

    <div class="toast" id="toast"></div>
    <div class="a2hs-tip" id="a2hsTip">
      <div class="row">
        <div>
          <div class="kicker">Install</div>
          For best experience on iPhone: tap Share → Add to Home Screen.
        </div>
        <button class="btn secondary" id="hideA2HS">Got it</button>
      </div>
    </div>
  </div>

  <script>
    // App State and Data
    const STORE_KEYS = {
      settings: 'kbdb.settings.v1',
      logs: 'kbdb.logs.v1',
      plan: 'kbdb.plan.v1'
    };

    const defaultSettings = {
      goal: 'hypertrophy', // strength | hypertrophy | conditioning
      daysPerWeek: 3,
      sessionMinutes: 45,
      includeDB: true,
      includeKB: true,
      weights: { // fixed to your equipment
        dbPairs: [25, 35],
        dbSingles: [25, 35],
        kbSingles: [50, 70]
      },
      restSeconds: { // defaults per goal
        strength: 150,
        hypertrophy: 90,
        conditioning: 45
      },
      timerBeep: true,
      timerVibrate: true
    };

    const EXERCISES = [
      { id: 'goblet_squat', name: 'Goblet Squat', cat: 'lower', equip: ['KB:70','KB:50','DBPair:35','DBPair:25'], default: 'KB:50', tips: 'Keep torso proud, elbows pointed down, knees track toes.' },
      { id: 'split_squat', name: 'Split Squat (RFESS optional)', cat: 'lower', equip: ['DBPair:25','DBPair:35','KB:50'], default: 'DBPair:25', tips: 'Front foot flat, control down, slight forward shin allowed.' },
      { id: 'rdl', name: 'Romanian Deadlift', cat: 'hinge', equip: ['KB:70','KB:50','DBPair:35','DBPair:25'], default: 'KB:70', tips: 'Hinge at hips, keep lats tight, slight knee bend.' },
      { id: 'swing', name: 'Kettlebell Swing', cat: 'hinge', equip: ['KB:50','KB:70'], default: 'KB:50', tips: 'Explosive hip drive, neutral spine. Hike the bell; don’t squat it.' },
      { id: 'row', name: 'One-Arm Row', cat: 'pull', equip: ['KB:70','KB:50','DB:35','DB:25'], default: 'KB:70', unilateral: true, tips: 'Pull elbow to hip, brace core, don’t rotate torso.' },
      { id: 'ohp', name: 'Overhead Press (standing)', cat: 'push', equip: ['DB:35','DB:25','KB:50'], default: 'DB:35', unilateral: true, tips: 'Glutes tight, ribs down, press to stacked overhead.' },
      { id: 'floor_press', name: 'Floor Press', cat: 'push', equip: ['DBPair:35','DBPair:25','KB:50'], default: 'DBPair:35', tips: 'Pause lightly on floor, elbows ~45° from torso.' },
      { id: 'pushup', name: 'Push-Up', cat: 'push', equip: ['BW'], default: 'BW', tips: 'Full range; elevate hands if needed to hit rep target.' },
      { id: 'carry_suitcase', name: 'Suitcase Carry', cat: 'carry', equip: ['KB:70','KB:50','DB:35'], default: 'KB:70', timed: true, tips: 'Tall posture, ribs stacked, slow steps; switch sides.' },
      { id: 'carry_farmer', name: 'Farmer Carry', cat: 'carry', equip: ['DBPair:35','DBPair:25'], default: 'DBPair:35', timed: true, tips: 'Short quick steps, shoulders down & back.' },
      { id: 'curl', name: 'Biceps Curl', cat: 'accessory', equip: ['DBPair:25','DB:35'], default: 'DBPair:25', tips: 'No swinging; squeeze at top.' },
      { id: 'triceps', name: 'Overhead Triceps Ext.', cat: 'accessory', equip: ['KB:50','DB:35'], default: 'KB:50', tips: 'Elbows in; get a full stretch overhead.' },
      { id: 'plank', name: 'Front Plank', cat: 'core', equip: ['BW'], default: 'BW', timed: true, tips: 'Glutes tight, ribs down, push floor away.' },
      { id: 'hollow', name: 'Hollow Hold', cat: 'core', equip: ['BW'], default: 'BW', timed: true, tips: 'Lower back kisses floor; regress by tucking legs.' }
    ];

    // Default 3-day templates tuned to available weights
    const TEMPLATES = {
      A: [
        { ex: 'goblet_squat' },
        { ex: 'row' },
        { ex: 'floor_press' },
        { ex: 'split_squat' },
        { ex: 'plank' }
      ],
      B: [
        { ex: 'rdl' },
        { ex: 'ohp' },
        { ex: 'swing' },
        { ex: 'carry_suitcase' },
        { ex: 'hollow' }
      ],
      C: [
        { ex: 'split_squat' },
        { ex: 'row' },
        { ex: 'pushup' },
        { ex: 'carry_farmer' },
        { ex: 'curl' }
      ]
    };

    // Rep schemes by goal and category
    const SCHEMES = {
      strength: {
        lower: { sets: 4, reps: '4-6', rest: 150 },
        hinge: { sets: 4, reps: '4-6', rest: 150 },
        push:  { sets: 4, reps: '5-7', rest: 120 },
        pull:  { sets: 4, reps: '5-7', rest: 120 },
        accessory: { sets: 3, reps: '8-12', rest: 90 },
        core: { sets: 3, time: '30-45s', rest: 60 },
        carry: { sets: 3, time: '30-45s/side', rest: 60 }
      },
      hypertrophy: {
        lower: { sets: 3, reps: '8-12', rest: 90 },
        hinge: { sets: 3, reps: '8-12', rest: 90 },
        push:  { sets: 3, reps: '8-12', rest: 75 },
        pull:  { sets: 3, reps: '8-12', rest: 75 },
        accessory: { sets: 3, reps: '10-15', rest: 60 },
        core: { sets: 3, time: '35-60s', rest: 45 },
        carry: { sets: 3, time: '40-60s/side', rest: 45 }
      },
      conditioning: {
        lower: { sets: 3, reps: '12-15', rest: 45 },
        hinge: { sets: 3, reps: '12-15', rest: 45 },
        push:  { sets: 3, reps: '12-15', rest: 40 },
        pull:  { sets: 3, reps: '12-15', rest: 40 },
        accessory: { sets: 2, reps: '12-20', rest: 30 },
        core: { sets: 3, time: '30-45s', rest: 30 },
        carry: { sets: 3, time: '30-45s/side', rest: 30 }
      }
    };

    // Utilities
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    function save(key, val) { localStorage.setItem(key, JSON.stringify(val)); }
    function load(key, fallback) {
      try { return JSON.parse(localStorage.getItem(key)) ?? fallback; } catch { return fallback; }
    }
    function toast(msg, ms=2200) {
      const t = $('#toast'); t.textContent = msg; t.style.display = 'block';
      clearTimeout(toast._id);
      toast._id = setTimeout(()=> t.style.display = 'none', ms);
    }
    function isIOS() { return /iphone|ipad|ipod/i.test(navigator.userAgent); }
    function isStandalone() {
      return (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || window.navigator.standalone === true;
    }
    function clamp(n, min, max) { return Math.min(max, Math.max(min, n)); }

    // Audio (beep) – created on first user gesture
    let audioCtx = null;
    function initAudio() {
      if (!audioCtx) {
        try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch {}
      }
    }
    function beep() {
      if (!audioCtx) return;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.connect(g); g.connect(audioCtx.destination);
      o.type = 'sine';
      o.frequency.setValueAtTime(880, audioCtx.currentTime);
      g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.2, audioCtx.currentTime + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.20);
      o.start(); o.stop(audioCtx.currentTime + 0.22);
    }
    function vibrate(ms=50) {
      if (navigator.vibrate) navigator.vibrate(ms);
    }

    // Settings/Plan/Logs
    let settings = Object.assign({}, defaultSettings, load(STORE_KEYS.settings, {}));
    let logs = load(STORE_KEYS.logs, []);
    let plan = load(STORE_KEYS.plan, null);

    function exById(id) { return EXERCISES.find(x => x.id === id); }

    // Build default plan from templates based on days/week
    function buildPlan() {
      const days = settings.daysPerWeek;
      const seq = ['A','B','C'];
      const chosen = seq.slice(0, Math.min(days, 3));
      const daysOut = chosen.map((code) => {
        const list = TEMPLATES[code].map(e => ({ id: e.ex }));
        return { code, name: `Day ${code}`, items: list };
      });
      return { goal: settings.goal, days: daysOut, createdAt: Date.now() };
    }

    // Derive scheme for an exercise based on goal and category
    function schemeFor(exId) {
      const ex = exById(exId);
      const sch = SCHEMES[settings.goal][ex.cat];
      return sch;
    }

    // Choose a default implement constrained by your gear, exercise compatibility, and toggles
    function defaultImplement(exId) {
      const ex = exById(exId);
      const allowed = ex.equip;
      const have = new Set([
        'DB:25','DB:35','DBPair:25','DBPair:35','KB:50','KB:70','BW'
      ]);
      const okToggle = (a) => {
        if (a.startsWith('DB') && !settings.includeDB) return false;
        if (a.startsWith('KB') && !settings.includeKB) return false;
        return true;
      };
      const viable = allowed.filter(a => have.has(a)).filter(okToggle);

      const pickFallback = () => {
        if (allowed.includes('BW')) return 'BW';
        // try to respect toggles even on fallback
        const firstOk = allowed.find(okToggle);
        return firstOk || allowed[0] || 'BW';
      };

      if (viable.length === 0) return pickFallback();

      if (settings.goal === 'strength') {
        const weightVal = v => v === 'BW' ? -1 : parseInt(v.split(':')[1] || '0', 10) + (v.startsWith('DBPair') ? 0.5 : 0);
        viable.sort((a,b)=> weightVal(b)-weightVal(a));
        return viable[0];
      } else {
        if (viable.includes(ex.default)) return ex.default;
        return viable[Math.floor(viable.length/2)];
      }
    }

    // Simple progressive suggestion based on last log of this exercise
    function nextProgressSuggestion(exId, currentImpl, target) {
      const last = [...logs].reverse().find(w => w.items?.some(it => it.id === exId));
      if (!last) return { implement: currentImpl, note: 'New: feel it out.' };

      const item = [...last.items].reverse().find(i => i.id === exId);
      if (!item) return { implement: currentImpl, note: 'No history yet.' };

      const ex = exById(exId);
      const lastSets = item.sets || [];
      let avgReps = null;
      let avgSecs = null;
      if (ex.timed) {
        const secs = lastSets.map(s => parseInt(s.timeSec || 0, 10)).filter(Boolean);
        if (secs.length) avgSecs = Math.round(secs.reduce((a,b)=>a+b,0)/secs.length);
      } else {
        const reps = lastSets.map(s => parseInt(s.reps || 0, 10)).filter(Boolean);
        if (reps.length) avgReps = Math.round(reps.reduce((a,b)=>a+b,0)/reps.length);
      }

      let top = null;
      if (target?.reps) {
        const parts = String(target.reps).split('-'); top = parseInt(parts[1] || parts[0], 10);
      }
      if (target?.time) {
        const m = /(\d+)-(\d+)s/.exec(target.time) || /(\d+)s/.exec(target.time);
        if (m) top = parseInt(m[2] || m[1], 10);
      }

      const have = new Set([
        'DB:25','DB:35','DBPair:25','DBPair:35','KB:50','KB:70','BW'
      ]);
      const viable = ex.equip.filter(a => have.has(a)).filter(a => {
        if (a.startsWith('DB') && !settings.includeDB) return false;
        if (a.startsWith('KB') && !settings.includeKB) return false;
        return true;
      });
      function heaviness(code) {
        if (code === 'BW') return 0;
        const parts = code.split(':');
        const w = parseInt(parts[1] || '0', 10);
        const pair = parts[0].startsWith('DBPair') ? 1 : 0;
        return w + (pair ? 0.5 : 0);
      }
      const sorted = viable.slice().sort((a,b) => heaviness(a) - heaviness(b));
      const idx = sorted.indexOf(currentImpl);
      const heavier = sorted[Math.min(sorted.length-1, idx+1)];
      const lighter = sorted[Math.max(0, idx-1)];

      if (!ex.timed && avgReps != null && top != null) {
        if (avgReps >= top + 2 && heavier && heavier !== currentImpl) {
          return { implement: heavier, note: 'Level up: go heavier.' };
        } else if (avgReps <= (top - 5) && lighter && lighter !== currentImpl) {
          return { implement: lighter, note: 'Go lighter to hit range.' };
        } else {
          return { implement: currentImpl, note: 'Keep load; push reps/tempo.' };
        }
      }
      if (ex.timed && avgSecs != null && top != null) {
        if (avgSecs >= top + 10 && heavier && heavier !== currentImpl) {
          return { implement: heavier, note: 'Level up: go heavier.' };
        } else if (avgSecs <= top - 15 && lighter && lighter !== currentImpl) {
          return { implement: lighter, note: 'Go lighter to hit time.' };
        } else {
          return { implement: currentImpl, note: 'Keep load; extend time/quality.' };
        }
      }
      return { implement: currentImpl, note: 'Match last session quality.' };
    }

    // UI Rendering
    const view = $('#view');
    const tabs = $$('nav.tabbar button');

    tabs.forEach(btn => btn.addEventListener('click', () => {
      tabs.forEach(b => b.classList.toggle('active', b===btn));
      render(btn.dataset.tab);
    }));

    $('#btnToday').addEventListener('click', () => {
      tabs.forEach(b => b.classList.toggle('active', b.dataset.tab==='workout'));
      render('workout');
      initAudio();
    });
    $('#btnSettings').addEventListener('click', () => {
      tabs.forEach(b => b.classList.toggle('active', b.dataset.tab==='plan'));
      render('plan');
    });

    function render(tab) {
      if (tab === 'plan') return renderPlan();
      if (tab === 'workout') return renderWorkout();
      if (tab === 'history') return renderHistory();
      renderPlan();
    }

    function renderPlan() {
      if (!plan) plan = buildPlan();
      save(STORE_KEYS.settings, settings);
      save(STORE_KEYS.plan, plan);

      view.innerHTML = '';
      const wrap = document.createElement('div');

      const cardSettings = document.createElement('div');
      cardSettings.className = 'card';
      cardSettings.innerHTML = `
        <h2>Your Setup</h2>
        <div class="sub">Tailored to dumbbells (25s, 35s) and kettlebells (50, 70). Adjust goal and session to refresh recommendations.</div>
        <div class="grid-2">
          <div class="field">
            <label>Goal</label>
            <div class="seg" role="tablist" aria-label="Goal">
              <button data-goal="strength" class="${settings.goal==='strength'?'active':''}">Strength</button>
              <button data-goal="hypertrophy" class="${settings.goal==='hypertrophy'?'active':''}">Hypertrophy</button>
              <button data-goal="conditioning" class="${settings.goal==='conditioning'?'active':''}">Condition</button>
            </div>
          </div>
          <div class="field">
            <label>Days per week</label>
            <div class="seg" role="tablist" aria-label="Days">
              <button data-days="2" class="${settings.daysPerWeek===2?'active':''}">2</button>
              <button data-days="3" class="${settings.daysPerWeek===3?'active':''}">3</button>
              <button data-days="4" class="${settings.daysPerWeek===4?'active':''}">4</button>
            </div>
          </div>
          <div class="field">
            <label>Session length</label>
            <div class="seg" role="tablist" aria-label="Minutes">
              <button data-mins="30" class="${settings.sessionMinutes===30?'active':''}">~30m</button>
              <button data-mins="45" class="${settings.sessionMinutes===45?'active':''}">~45m</button>
              <button data-mins="60" class="${settings.sessionMinutes===60?'active':''}">~60m</button>
            </div>
          </div>
          <div class="field">
            <label>Include equipment</label>
            <div class="seg">
              <button data-eq="DB" class="${settings.includeDB?'active':''}">Dumbbells</button>
              <button data-eq="KB" class="${settings.includeKB?'active':''}">Kettlebells</button>
            </div>
          </div>
        </div>
        <details class="hint">
          <summary>Progression tips</summary>
          Aim RPE 7–9 on last set. If you hit the top of the rep/time range with good form across sets, next time either:
          increase load (if available), add 1–2 reps, add a pause/tempo, or reduce rest slightly.
        </details>
        <div class="row">
          <button class="btn" id="btnRebuild">Refresh Plan</button>
          <button class="btn ghost" id="btnExport">Export</button>
          <button class="btn ghost" id="btnImport">Import</button>
        </div>
      `;
      wrap.appendChild(cardSettings);

      cardSettings.querySelectorAll('[data-goal]').forEach(b=> b.addEventListener('click', ()=>{
        settings.goal = b.dataset.goal;
        cardSettings.querySelectorAll('[data-goal]').forEach(x=> x.classList.toggle('active', x===b));
      }));
      cardSettings.querySelectorAll('[data-days]').forEach(b=> b.addEventListener('click', ()=>{
        settings.daysPerWeek = parseInt(b.dataset.days, 10);
        cardSettings.querySelectorAll('[data-days]').forEach(x=> x.classList.toggle('active', x===b));
      }));
      cardSettings.querySelectorAll('[data-mins]').forEach(b=> b.addEventListener('click', ()=>{
        settings.sessionMinutes = parseInt(b.dataset.mins, 10);
        cardSettings.querySelectorAll('[data-mins]').forEach(x=> x.classList.toggle('active', x===b));
      }));
      cardSettings.querySelectorAll('[data-eq]').forEach(b=> b.addEventListener('click', ()=>{
        const t = b.dataset.eq;
        if (t==='DB') settings.includeDB = !settings.includeDB;
        if (t==='KB') settings.includeKB = !settings.includeKB;
        b.classList.toggle('active');
      }));
      $('#btnRebuild', cardSettings).addEventListener('click', ()=>{
        plan = buildPlan();
        save(STORE_KEYS.settings, settings);
        save(STORE_KEYS.plan, plan);
        toast('Plan refreshed');
        renderPlan();
      });

      // Export/Import
      $('#btnExport', cardSettings).addEventListener('click', ()=>{
        const payload = { settings, plan, logs };
        const txt = JSON.stringify(payload, null, 2);
        navigator.clipboard?.writeText(txt).then(()=> toast('Copied backup to clipboard')).catch(()=>{
          const pre = document.createElement('pre'); pre.textContent = txt; pre.style.whiteSpace='pre-wrap'; pre.className='card';
          view.appendChild(pre);
          toast('Scroll to copy backup text');
        });
      });
      $('#btnImport', cardSettings).addEventListener('click', ()=>{
        const raw = prompt('Paste your backup JSON:');
        if (!raw) return;
        try {
          const payload = JSON.parse(raw);
          if (payload.settings) settings = Object.assign({}, defaultSettings, payload.settings);
          if (payload.plan) plan = payload.plan;
          if (Array.isArray(payload.logs)) logs = payload.logs;
          save(STORE_KEYS.settings, settings);
          save(STORE_KEYS.plan, plan);
          save(STORE_KEYS.logs, logs);
          toast('Imported successfully');
          renderPlan();
        } catch (e) {
          toast('Import failed: invalid JSON');
        }
      });

      // Plan Days
      const cardDays = document.createElement('div');
      cardDays.className = 'card';
      cardDays.innerHTML = `<h2>Weekly Plan</h2><div class="sub">Based on your goal: ${settings.goal.charAt(0).toUpperCase()+settings.goal.slice(1)}. Tap Start to move to Workout.</div>`;
      const list = document.createElement('div'); list.style.display='grid'; list.style.gap='12px';

      if (!plan) plan = buildPlan();
      plan.days.forEach((d, idx) => {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'exercise';
        const items = d.items.map(it=>{
          const ex = exById(it.id);
          const sch = schemeFor(it.id);
          const impl = defaultImplement(it.id);
          const target = ex.timed ? sch.time : sch.reps;
          return `
            <div class="row wrap">
              <h3>${ex.name}</h3>
              <div class="tags">
                <span class="tag grey">${ex.cat}</span>
                <span class="tag">Target: ${target || ''} ${ex.timed ? '' : 'reps'}</span>
                <span class="tag green">${impl.replace('Pair',' x2')}</span>
              </div>
            </div>
            <div class="small muted">${ex.tips}</div>
          `;
        }).join('<hr style="opacity:.1;border:0;border-top:1px solid color-mix(in oklab, var(--muted) 25%, transparent)">');

        dayDiv.innerHTML = `
          <div class="row">
            <div><div class="kicker">Day</div><h3 style="margin:4px 0">${d.name}</h3></div>
            <button class="btn secondary" data-start="${idx}">Start</button>
          </div>
          <div style="display:grid;gap:10px">${items}</div>
        `;
        list.appendChild(dayDiv);
      });
      cardDays.appendChild(list);
      wrap.appendChild(cardDays);

      view.appendChild(wrap);
      save(STORE_KEYS.settings, settings);

      // Start day handlers
      $$('button[data-start]').forEach(b => b.addEventListener('click', ()=>{
        startWorkout(parseInt(b.dataset.start, 10));
        tabs.forEach(x=> x.classList.toggle('active', x.dataset.tab==='workout'));
      }));
    }

    // Session model
    let session = null; // { dayIdx, goal, items: [{...}], startedAt, completedAt }

    function startWorkout(dayIdx = 0) {
      if (!plan) plan = buildPlan();
      const d = plan.days[dayIdx] || plan.days[0];
      const goal = plan.goal;

      const items = d.items.map(it => {
        const ex = exById(it.id);
        const sch = schemeFor(it.id);
        const setsN = sch.sets || 3;
        const target = ex.timed ? sch.time : sch.reps;
        const impl0 = defaultImplement(ex.id);
        const prog = nextProgressSuggestion(ex.id, impl0, sch);
        const rest = sch.rest ?? 60;

        return {
          id: ex.id, name: ex.name, cat: ex.cat, timed: !!ex.timed, unilateral: !!ex.unilateral,
          implement: prog.implement, note: prog.note,
          target, rest,
          sets: Array.from({length: setsN}, ()=> ({ reps: '', rpe: '', timeSec: '', complete: false })),
          tips: ex.tips
        };
      });

      session = { dayIdx, goal, startedAt: Date.now(), items, completedAt: null };
      renderWorkout();
    }

    function endWorkout() {
      if (!session) return;
      session.completedAt = Date.now();
      logs.push({
        at: session.completedAt,
        goal: session.goal,
        dayIdx: session.dayIdx,
        items: session.items.map(it => ({
          id: it.id, implement: it.implement, target: it.target, rest: it.rest,
          sets: it.sets
        }))
      });
      save(STORE_KEYS.logs, logs);
      toast('Workout saved');
      session = null;
      clearTimer();
      renderWorkout();
    }

    // Timer system (single active timer per app)
    let timer = { active: false, total: 0, left: 0, id: null, bar: null, label: null, startTime: 0 };

    function updateTimerUI() {
      if (timer.label) timer.label.textContent = `${Math.max(0, Math.round(timer.left))}s`;
      if (timer.bar) {
        const pct = 1 - (timer.left / Math.max(1, timer.total));
        timer.bar.style.width = `${Math.round(100 * Math.min(1, Math.max(0, pct)))}%`;
      }
    }

    function finishTimer() {
      if (timer.id) { clearInterval(timer.id); timer.id = null; }
      timer.active = false;
      timer.left = 0;
      updateTimerUI();
      if (settings.timerBeep) beep();
      if (settings.timerVibrate) vibrate(35);
      toast('Rest complete');
    }

    function clearTimer() {
      if (timer.id) { clearInterval(timer.id); }
      timer = { active: false, total: 0, left: 0, id: null, bar: null, label: null, startTime: 0 };
    }

    function startTimer(totalSec, labelEl, barEl, options = {}) {
      initAudio();
      if (timer.id) clearInterval(timer.id);
      timer.active = true;
      timer.total = Math.max(1, parseInt(totalSec || 0, 10));
      timer.bar = barEl;
      timer.label = labelEl;
      // If presetLeft provided, use it; else full duration
      const presetLeft = typeof options.presetLeft === 'number' ? options.presetLeft : timer.total;
      timer.left = clamp(presetLeft, 0, timer.total);
      // Align startTime so that current left is respected
      timer.startTime = Date.now() - 1000 * (timer.total - timer.left);

      function tick() {
        const elapsed = Math.floor((Date.now() - timer.startTime) / 1000);
        timer.left = Math.max(0, timer.total - elapsed);
        updateTimerUI();
        if (timer.left <= 0) finishTimer();
      }
      updateTimerUI();
      timer.id = setInterval(tick, 250);
    }

    // Adjust running timer by +/- seconds if it's the one in this exercise block
    function adjustRunningTimer(deltaSec, exDiv) {
      if (!timer.active) return false;
      const labelEl = exDiv.querySelector('.rest-timer .muted span');
      const barEl = exDiv.querySelector('.progress > div');
      if (timer.label !== labelEl || timer.bar !== barEl) return false;

      const newTotal = Math.max(1, timer.total + deltaSec);
      const newLeft = Math.max(0, Math.min(newTotal, timer.left + deltaSec));
      timer.total = newTotal;
      timer.left = newLeft;
      timer.startTime = Date.now() - 1000 * (timer.total - timer.left);
      updateTimerUI();
      if (timer.left <= 0) finishTimer();
      return true;
    }

    function renderWorkout() {
      view.innerHTML = '';
      const wrap = document.createElement('div');

      if (!session) {
        const card = document.createElement('div');
        card.className = 'card';
        const d0 = plan?.days?.[0]?.name || 'Day A';
        const d1 = plan?.days?.[1]?.name;
        const d2 = plan?.days?.[2]?.name;
        card.innerHTML = `
          <h2>Workout</h2>
          <div class="sub">Start any day from your plan. Your rest timer, sets, and progress will be saved locally.</div>
          <div class="row">
            <button class="btn" id="startDay0">Start ${d0}</button>
            ${d1 ? `<button class="btn secondary" id="startDay1">Start ${d1}</button>` : ''}
            ${d2 ? `<button class="btn secondary" id="startDay2">Start ${d2}</button>` : ''}
          </div>
        `;
        wrap.appendChild(card);
        view.appendChild(wrap);
        $('#startDay0', card)?.addEventListener('click', ()=> { startWorkout(0); initAudio(); });
        $('#startDay1', card)?.addEventListener('click', ()=> { startWorkout(1); initAudio(); });
        $('#startDay2', card)?.addEventListener('click', ()=> { startWorkout(2); initAudio(); });
        return;
      }

      const header = document.createElement('div');
      header.className = 'card';
      const dayName = plan.days[session.dayIdx]?.name || `Day ${session.dayIdx+1}`;
      header.innerHTML = `
        <div class="row wrap">
          <div>
            <div class="kicker">In Session</div>
            <h2 style="margin:4px 0">${dayName} · ${session.goal.charAt(0).toUpperCase()+session.goal.slice(1)}</h2>
            <div class="sub">Tap fields to log reps or seconds. Use the Rest button on each exercise.</div>
          </div>
          <div class="row" style="gap:6px">
            <button class="btn ghost" id="btnCancel">Cancel</button>
            <button class="btn" id="btnFinish">Finish</button>
          </div>
        </div>
      `;
      wrap.appendChild(header);

      const list = document.createElement('div'); list.style.display='grid'; list.style.gap='12px';
      session.items.forEach((it) => {
        const exDiv = document.createElement('div');
        exDiv.className = 'exercise';

        const implementsList = (exById(it.id).equip || []).filter(eq => {
          const has = ['DB:25','DB:35','DBPair:25','DBPair:35','KB:50','KB:70','BW'];
          if (!settings.includeDB && eq.startsWith('DB')) return false;
          if (!settings.includeKB && eq.startsWith('KB')) return false;
          return has.includes(eq);
        });

        const implOptions = implementsList.map(eq => {
          const label = eq.replace('Pair',' x2');
          const isActive = (eq === it.implement);
          return `<option value="${eq}" ${isActive?'selected':''}>${label}</option>`;
        }).join('');

        const setRows = it.sets.map((s, si) => {
          return `
            <div class="set-row">
              <div class="muted small">#${si+1}</div>
              <div class="pill">${it.timed ? `<input type="number" min="0" inputmode="numeric" placeholder="sec" value="${s.timeSec || ''}" aria-label="Seconds">`
                                            : `<input type="number" min="0" inputmode="numeric" placeholder="reps" value="${s.reps || ''}" aria-label="Reps">`}</div>
              <div class="pill">
                <select aria-label="RPE">
                  <option value="">RPE</option>
                  <option ${s.rpe=='6'?'selected':''}>6</option>
                  <option ${s.rpe=='7'?'selected':''}>7</option>
                  <option ${s.rpe=='8'?'selected':''}>8</option>
                  <option ${s.rpe=='9'?'selected':''}>9</option>
                  <option ${s.rpe=='10'?'selected':''}>10</option>
                </select>
              </div>
              <div class="pill small muted">${it.timed ? `Target: ${it.target}` : `Target: ${it.target} reps`}</div>
              <div style="text-align:center">
                <input type="checkbox" ${s.complete?'checked':''} aria-label="Set done">
              </div>
            </div>
          `;
        }).join('');

        exDiv.innerHTML = `
          <div class="row wrap">
            <h3>${it.name}</h3>
            <div class="tags">
              <span class="tag grey">${it.cat}</span>
              <span class="tag">${it.timed ? it.target : `${it.target} reps`}</span>
              <span class="tag green">${it.implement.replace('Pair',' x2')}</span>
            </div>
          </div>
          <div class="small muted">${it.tips} <span class="small" style="color:var(--ok)">· ${it.note || ''}</span></div>
          <div class="row wrap" style="gap:8px">
            <div class="field" style="min-width:180px; flex:1">
              <label>Implement</label>
              <div class="pill"><select data-impl>${implOptions}</select></div>
            </div>
            <div class="field" style="width:130px">
              <label>Rest</label>
              <div class="pill"><input data-rest type="number" min="10" step="5" value="${it.rest}"></div>
            </div>
            <div class="field" style="width:160px">
              <label>Quick Presets</label>
              <div class="seg">
                <button data-preset="down">-10s</button>
                <button data-preset="up">+10s</button>
                <button data-preset="start">Rest</button>
              </div>
            </div>
          </div>
          <div class="sets">${setRows}</div>
          <div class="rest-timer">
            <div class="progress"><div></div></div>
            <div class="muted small"><span>0s</span></div>
          </div>
        `;

        // Wire implement change
        $('select[data-impl]', exDiv).addEventListener('change', (e)=>{
          it.implement = e.target.value;
          exDiv.querySelector('.tags .tag.green').textContent = it.implement.replace('Pair',' x2');
        });

        // Wire rest change and presets
        const restInput = $('input[data-rest]', exDiv);
        restInput.addEventListener('input', e => {
          const val = parseInt(e.target.value || 0, 10);
          it.rest = clamp(isNaN(val) ? 0 : val, 10, 600);
        });

        $$('.seg [data-preset]', exDiv).forEach(btn => btn.addEventListener('click', ()=>{
          if (btn.dataset.preset==='up') {
            it.rest = clamp((it.rest||0)+10, 10, 600);
            restInput.value = it.rest;
            adjustRunningTimer(10, exDiv);
          }
          if (btn.dataset.preset==='down') {
            it.rest = clamp((it.rest||0)-10, 10, 600);
            restInput.value = it.rest;
            adjustRunningTimer(-10, exDiv);
          }
          if (btn.dataset.preset==='start') {
            const label = exDiv.querySelector('.rest-timer .muted span');
            const bar = exDiv.querySelector('.progress > div');
            startTimer(it.rest || 60, label, bar);
          }
        }));

        // Wire sets
        $$('.set-row', exDiv).forEach((row, si) => {
          const inputs = row.querySelectorAll('input');
          const rpeSel = row.querySelector('select');
          const [valInput] = inputs;
          const chk = inputs[inputs.length-1];

          valInput.addEventListener('input', e => {
            if (it.timed) { it.sets[si].timeSec = parseInt(e.target.value || 0, 10); }
            else { it.sets[si].reps = parseInt(e.target.value || 0, 10); }
          });
          rpeSel.addEventListener('change', e => {
            it.sets[si].rpe = e.target.value || '';
          });
          chk.addEventListener('change', e => {
            it.sets[si].complete = !!e.target.checked;
            if (chk.checked) {
              const label = exDiv.querySelector('.rest-timer .muted span');
              const bar = exDiv.querySelector('.progress > div');
              startTimer(it.rest || 60, label, bar);
            }
          });
        });

        list.appendChild(exDiv);
      });
      wrap.appendChild(list);

      // Footer actions
      $('#btnCancel', header).addEventListener('click', ()=>{
        if (confirm('Cancel this workout? Your unsaved entries will be lost.')) {
          session = null; clearTimer(); renderWorkout();
        }
      });
      $('#btnFinish', header).addEventListener('click', ()=>{
        const hasAny = session.items.some(it => it.sets.some(s => s.reps || s.timeSec));
        if (!hasAny) {
          if (!confirm('No sets logged. Save anyway?')) return;
        }
        endWorkout();
      });

      view.appendChild(wrap);
    }

    function renderHistory() {
      view.innerHTML = '';
      const wrap = document.createElement('div');

      const head = document.createElement('div');
      head.className = 'card';
      head.innerHTML = `<h2>History</h2><div class="sub">${logs.length ? 'Your last sessions are below.' : 'No workouts logged yet.'}</div>`;
      wrap.appendChild(head);

      // Aggregate last used loads per exercise
      const lastMap = new Map();
      for (let i = logs.length - 1; i >= 0; i--) {
        const w = logs[i];
        (w.items || []).forEach(it => {
          if (!lastMap.has(it.id)) lastMap.set(it.id, it);
        });
      }
      if (lastMap.size) {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `<h2>Last Used Loads</h2>`;
        const grid = document.createElement('div'); grid.style.display='grid'; grid.style.gap='10px';
        lastMap.forEach((it, id) => {
          const ex = exById(id);
          const div = document.createElement('div'); div.className='exercise';
          const avg = (()=> {
            const reps = (it.sets||[]).map(s=> parseInt(s.reps||0,10)).filter(Boolean);
            const secs = (it.sets||[]).map(s=> parseInt(s.timeSec||0,10)).filter(Boolean);
            if (secs.length) return `${Math.round(secs.reduce((a,b)=>a+b,0)/secs.length)}s`;
            if (reps.length) return `${Math.round(reps.reduce((a,b)=>a+b,0)/reps.length)} reps`;
            return '—';
          })();
          div.innerHTML = `
            <div class="row wrap">
              <h3>${ex.name}</h3>
              <div class="tags">
                <span class="tag grey">${ex.cat}</span>
                <span class="tag green">${(it.implement || '—').replace('Pair',' x2')}</span>
                <span class="tag">Avg: ${avg}</span>
              </div>
            </div>
          `;
          grid.appendChild(div);
        });
        card.appendChild(grid);
        wrap.appendChild(card);
      }

      // Workout list with per-entry delete
      logs.slice().reverse().forEach((w, i) => {
        const idxOrig = logs.length - 1 - i;
        const card = document.createElement('div'); card.className='card';
        const dt = new Date(w.at);
        card.innerHTML = `
          <div class="row">
            <h2>${dt.toLocaleString([], {dateStyle:'medium', timeStyle:'short'})}</h2>
            <div class="row" style="gap:8px">
              <div class="tag grey">${w.goal}</div>
              <button class="icon-btn danger" data-del="${idxOrig}">Delete</button>
            </div>
          </div>
        `;
        (w.items || []).forEach(it => {
          const ex = exById(it.id);
          const row = document.createElement('div'); row.className='exercise';
          const lines = (it.sets||[]).map((s, i2) => {
            const val = (s.timeSec ? `${s.timeSec}s` : (s.reps ? `${s.reps} reps` : '—'));
            return `<span class="pill small" style="margin-right:6px">#${i2+1} ${val}${s.rpe?` · RPE${s.rpe}`:''}</span>`;
          }).join('');
          row.innerHTML = `
            <div class="row wrap">
              <h3>${ex.name}</h3>
              <div class="tags">
                <span class="tag green">${(it.implement||'—').replace('Pair',' x2')}</span>
                <span class="tag">${ex.timed ? it.target : `${it.target} reps`}</span>
              </div>
            </div>
            <div class="row wrap small muted">${lines || 'No sets recorded.'}</div>
          `;
          card.appendChild(row);
        });

        // Delete handler
        $('button[data-del]', card)?.addEventListener('click', () => {
          if (confirm('Delete this workout from history?')) {
            logs.splice(idxOrig, 1);
            save(STORE_KEYS.logs, logs);
            toast('History entry deleted');
            renderHistory();
          }
        });

        wrap.appendChild(card);
      });

      view.appendChild(wrap);
    }

    // A2HS tip for iOS Safari
    function maybeShowA2HSTip() {
      const tip = $('#a2hsTip');
      const key = 'kbdb.a2hs.dismissed';
      if (isIOS() && !isStandalone() && !localStorage.getItem(key)) {
        tip.style.display = 'block';
        $('#hideA2HS').onclick = () => { tip.style.display='none'; localStorage.setItem(key, '1'); };
      }
    }

    // Init
    document.addEventListener('click', initAudio, { once: true });
    window.addEventListener('load', ()=>{
      render('plan');
      maybeShowA2HSTip();
    });
  </script>
</body>
</html>
