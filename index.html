<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Iron & Bell Tracker</title>
    
    <!-- Web Manifest with Custom Icon -->
    <link rel="manifest" href='data:application/json;charset=utf-8,{"name":"Iron %26 Bell","short_name":"Iron Bell","start_url":".","display":"standalone","background_color":"#0f172a","theme_color":"#0f172a","icons":[{"src":"https://i.postimg.cc/4dMyqKbg/IMG-0587.jpg","sizes":"192x192","type":"image/jpeg"},{"src":"https://i.postimg.cc/4dMyqKbg/IMG-0587.jpg","sizes":"512x512","type":"image/jpeg"}]}'>
    
    <!-- iOS Home Screen Icon -->
    <link rel="apple-touch-icon" href="https://i.postimg.cc/4dMyqKbg/IMG-0587.jpg">
    
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">

    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            background-color: #0f172a; /* Slate 900 */
            color: #e2e8f0; /* Slate 200 */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: env(safe-area-inset-bottom);
            overscroll-behavior-y: none;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .glass-panel {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }
        .glass-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.6), rgba(15, 23, 42, 0.8));
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            opacity: 0.6;
            cursor: pointer;
        }
        .active-tab {
            color: #fbbf24; /* Amber 400 */
            position: relative;
        }
        .active-tab::after {
            content: '';
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            background-color: #fbbf24;
            border-radius: 50%;
            box-shadow: 0 0 10px #fbbf24;
        }
        @keyframes pulse-amber {
            0%, 100% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.4); border-color: rgba(251, 191, 36, 0.6); }
            50% { box-shadow: 0 0 0 4px rgba(251, 191, 36, 0); border-color: rgba(251, 191, 36, 1); }
        }
        .timer-active {
            animation: pulse-amber 2s infinite;
        }
        /* Animations */
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-up {
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- DATA CONFIG ---
        const ROUTINES = {
            WARMUP: {
                id: 'warmup',
                title: 'RAMP Warm-Up',
                subtitle: 'Prepare & Mobilize',
                exercises: [
                    { id: 'w1', name: 'Cat-Cow & Rotation', sets: 1, reps: '60 sec', note: 'Arch up, sink down, then rotate.' },
                    { id: 'w2', name: '90/90 Hip Switches', sets: 1, reps: '60 sec', note: 'Sit on floor, rotate hips side to side.' },
                    { id: 'w3', name: 'Deadbugs', sets: 3, reps: '10 reps', note: 'Keep lower back glued to floor.' },
                    { id: 'w4', name: 'Kettlebell Halo', sets: 1, reps: '10/side', note: 'Circle around head. Ribs down.' },
                    { id: 'w5', name: 'Goblet Squat Prying', sets: 1, reps: '30 sec', note: 'Sit in squat. Push knees out.' }
                ]
            },
            WORKOUT_A: {
                id: 'workout_a',
                title: 'Workout A: Strength',
                subtitle: 'Heavy & Explosive',
                exercises: [
                    { id: 'a1', name: 'Heavy Goblet Squat', sets: 4, reps: '6-8', weightRec: '50 or 70 lb KB', note: 'Pause 1s at bottom. Chest tall.' },
                    { id: 'a2', name: 'Kettlebell Swing', sets: 4, reps: '15-20', weightRec: '50 or 70 lb KB', note: 'Explosive hinge. Snap glutes.' },
                    { id: 'a3', name: 'Floor Press', sets: 3, reps: '8-12', weightRec: '35lb DBs / 50lb KB', note: 'Elbows 45 degrees.' },
                    { id: 'a4', name: 'Gorilla Row', sets: 3, reps: '8-10', weightRec: '50 or 70 lb KB', note: 'Wide stance. Alternate pulls.' },
                    { id: 'a5', name: 'Farmer\'s Carry', sets: 3, reps: '40 yds', weightRec: '50 + 70 lb KB', note: 'Walk tall. Switch halfway.' }
                ]
            },
            WORKOUT_B: {
                id: 'workout_b',
                title: 'Workout B: Hypertrophy',
                subtitle: 'Volume & Stability',
                exercises: [
                    { id: 'b1', name: 'Reverse Lunges', sets: 3, reps: '8-10/leg', weightRec: '25/35 lb DBs', note: 'Knee gently touches floor.' },
                    { id: 'b2', name: 'Single-Leg RDL', sets: 3, reps: '8-10/leg', weightRec: '35/50 lb KB', note: 'Opposite hand to working leg.' },
                    { id: 'b3', name: 'Overhead Press', sets: 3, reps: '8-12', weightRec: '25/35 lb DBs', note: 'Brace core. No arching.' },
                    { id: 'b4', name: '3-Point Row', sets: 3, reps: '10-12', weightRec: '50 lb KB', note: 'Hand on bench. Pull to hip.' },
                    { id: 'b5', name: 'Hollow Pullover', sets: 3, reps: '12-15', weightRec: '25/35 lb DB', note: 'Legs up. Stretch lat.' }
                ]
            }
        };

        // --- COMPONENTS ---

        const Icon = ({ name, size = 20, color = "currentColor", className = "" }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className} style={{color}}></i>;
        };

        // FORMAT HELPERS
        const formatDuration = (ms) => {
            if (!ms) return '0m';
            const minutes = Math.floor(ms / 60000);
            return `${minutes}m`;
        };

        const formatTime = (seconds) => {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        };

        // 1. SMALL SESSION TIMER (Header)
        const SessionTimer = ({ startTime }) => {
            const [elapsed, setElapsed] = useState(0);

            useEffect(() => {
                if (!startTime) return;
                setElapsed(Date.now() - startTime);
                const interval = setInterval(() => setElapsed(Date.now() - startTime), 1000);
                return () => clearInterval(interval);
            }, [startTime]);

            return (
                <div className="flex items-center gap-2 bg-slate-800/50 px-3 py-1 rounded-full border border-amber-500/20">
                    <div className="w-2 h-2 rounded-full bg-amber-500 animate-pulse"></div>
                    <span className="font-mono text-amber-400 font-bold text-sm">{formatTime(Math.floor(elapsed / 1000))}</span>
                </div>
            );
        };

        // 2. REST TIMER (Floating)
        const RestTimer = ({ isOpen, onClose, autoStartTrigger }) => {
            const [time, setTime] = useState(0);
            const [isRunning, setIsRunning] = useState(false);

            useEffect(() => {
                if (autoStartTrigger) {
                    setTime(0);
                    setIsRunning(true);
                }
            }, [autoStartTrigger]);

            useEffect(() => {
                let interval;
                if (isRunning) {
                    interval = setInterval(() => setTime(t => t + 1), 1000);
                }
                return () => clearInterval(interval);
            }, [isRunning]);

            if (!isOpen) return null;

            return (
                <div className="fixed bottom-24 right-4 z-50 animate-slide-up">
                    <div className={`glass-panel p-4 rounded-2xl shadow-2xl flex flex-col items-center w-48 transition-all duration-300 ${isRunning ? 'border-amber-500/50 timer-active' : 'border-slate-700'}`}>
                        <div className="flex justify-between w-full items-center mb-2">
                            <span className="text-amber-400 text-[10px] font-bold tracking-widest uppercase">{isRunning ? 'Resting' : 'Paused'}</span>
                            <button onClick={onClose}><Icon name="x" size={14} className="text-slate-400 hover:text-white" /></button>
                        </div>
                        <div className="text-4xl font-mono font-bold text-white mb-4 tabular-nums">{formatTime(time)}</div>
                        <div className="flex gap-2 w-full">
                            <button 
                                onClick={() => setIsRunning(!isRunning)} 
                                className={`flex-1 py-2 rounded-lg font-bold text-xs transition-colors ${isRunning ? 'bg-slate-700 text-slate-300' : 'bg-amber-500 text-slate-900'}`}
                            >
                                {isRunning ? 'PAUSE' : 'RESUME'}
                            </button>
                            <button 
                                onClick={() => { setIsRunning(false); setTime(0); }}
                                className="p-2 bg-slate-700 rounded-lg text-slate-300 hover:bg-slate-600"
                            >
                                <Icon name="rotate-ccw" size={16} />
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // 3. EXERCISE CARD
        const ExerciseCard = ({ exercise, logs, onLog, isWorkoutActive }) => {
            const [isExpanded, setIsExpanded] = useState(false);
            const [inputWeight, setInputWeight] = useState('');
            const [inputReps, setInputReps] = useState('');
            
            const exerciseLogs = logs.filter(l => l.exerciseId === exercise.id);
            const setsCompletedCount = exerciseLogs.length;
            const isComplete = setsCompletedCount >= exercise.sets;
            const lastLog = exerciseLogs.length > 0 ? exerciseLogs[exerciseLogs.length - 1] : null;

            const handleSave = (e) => {
                e.stopPropagation();
                if (!isWorkoutActive) {
                    // Simple toast replacement (alert is fallback, but logic below ensures flow)
                    alert("Please tap 'Start Workout' first!");
                    return;
                }
                if (inputWeight && inputReps) {
                    onLog(exercise.id, { 
                        weight: inputWeight, 
                        reps: inputReps,
                        exerciseName: exercise.name 
                    });
                }
            };

            return (
                <div className={`mb-3 rounded-xl border overflow-hidden transition-all duration-300 glass-card ${isComplete ? 'opacity-60 grayscale-[0.5]' : ''}`}>
                    <div className="p-4 relative overflow-hidden" onClick={() => setIsExpanded(!isExpanded)}>
                        <div className="absolute left-0 top-0 bottom-0 bg-amber-500/10 transition-all duration-500" style={{ width: `${(setsCompletedCount / exercise.sets) * 100}%` }} />
                        <div className="flex items-start justify-between mb-2 relative z-10">
                            <div className="flex-1">
                                <h3 className={`font-bold text-lg ${isComplete ? 'text-slate-400 line-through decoration-slate-600' : 'text-slate-100'}`}>
                                    {exercise.name}
                                </h3>
                            </div>
                             <div className={`transition-transform duration-300 text-slate-500 ${isExpanded ? 'rotate-180 text-amber-500' : ''}`}>
                                <Icon name="chevron-down" size={20} />
                            </div>
                        </div>
                        <div className="flex items-center gap-3 relative z-10">
                            <div className="flex gap-1">
                                {[...Array(exercise.sets)].map((_, i) => (
                                    <div key={i} className={`h-1.5 w-6 rounded-full transition-all duration-300 ${i < setsCompletedCount ? 'bg-amber-500 shadow-[0_0_8px_rgba(245,158,11,0.6)]' : 'bg-slate-700'}`} />
                                ))}
                            </div>
                            <span className="text-[10px] text-slate-400 font-mono tracking-widest uppercase">
                                {setsCompletedCount}/{exercise.sets} Sets
                            </span>
                        </div>
                    </div>
                    {isExpanded && (
                        <div className="px-4 pb-4 pt-2 border-t border-slate-700/50 animate-slide-up bg-slate-900/40">
                            <div className="text-xs text-slate-400 mb-4 flex items-start gap-2 bg-slate-900/60 p-2 rounded border border-slate-800">
                                <Icon name="info" size={14} className="text-amber-500 mt-0.5 shrink-0" />
                                <div><p>{exercise.note}</p><p className="text-amber-500/80 mt-1 font-bold">Goal: {exercise.weightRec}</p></div>
                            </div>
                            <div className="flex gap-3 items-end">
                                <div className="flex-1">
                                    <label className="text-[9px] text-slate-500 uppercase font-bold tracking-wider mb-1 block">Lbs</label>
                                    <input type="number" value={inputWeight} onChange={(e) => setInputWeight(e.target.value)} placeholder={lastLog ? lastLog.weight : "0"} className="w-full bg-slate-950 border border-slate-800 rounded-lg p-3 text-white font-mono text-lg outline-none placeholder-slate-700 focus:border-amber-500" onClick={(e) => e.stopPropagation()} />
                                </div>
                                <div className="flex-1">
                                    <label className="text-[9px] text-slate-500 uppercase font-bold tracking-wider mb-1 block">Reps</label>
                                    <input type="number" value={inputReps} onChange={(e) => setInputReps(e.target.value)} placeholder={exercise.reps.split('-')[0]} className="w-full bg-slate-950 border border-slate-800 rounded-lg p-3 text-white font-mono text-lg outline-none placeholder-slate-700 focus:border-amber-500" onClick={(e) => e.stopPropagation()} />
                                </div>
                                <button onClick={handleSave} disabled={!inputWeight || !inputReps} className="bg-gradient-to-br from-amber-400 to-amber-600 disabled:from-slate-800 disabled:to-slate-800 disabled:text-slate-600 text-slate-900 font-bold rounded-lg flex items-center justify-center w-14 h-[52px] shadow-lg active:scale-95 transition-all"><Icon name="check" size={24} strokeWidth={3} /></button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 4. DETAILED MANUAL ENTRY FORM
        const ManualEntryModal = ({ isOpen, onClose, onSave }) => {
            if (!isOpen) return null;

            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [routineId, setRoutineId] = useState('workout_a'); 
            const [duration, setDuration] = useState(45);
            const [entryData, setEntryData] = useState({});

            useEffect(() => {
                if (isOpen) {
                    const routine = Object.values(ROUTINES).find(r => r.id === routineId);
                    const initialData = {};
                    if (routine) {
                        routine.exercises.forEach(ex => {
                            initialData[ex.id] = Array.from({ length: ex.sets }, () => ({ weight: '', reps: '' }));
                        });
                    }
                    setEntryData(initialData);
                }
            }, [isOpen, routineId]);

            const handleSetChange = (exId, index, field, value) => {
                const newSets = [...entryData[exId]];
                newSets[index] = { ...newSets[index], [field]: value };
                setEntryData({ ...entryData, [exId]: newSets });
            };

            const addSet = (exId) => {
                setEntryData({ ...entryData, [exId]: [...entryData[exId], { weight: '', reps: '' }] });
            };

            const removeSet = (exId, index) => {
                const newSets = entryData[exId].filter((_, i) => i !== index);
                setEntryData({ ...entryData, [exId]: newSets });
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                const routine = Object.values(ROUTINES).find(r => r.id === routineId);
                const logs = [];
                
                if (routine) {
                    routine.exercises.forEach(ex => {
                        const sets = entryData[ex.id] || [];
                        sets.forEach(set => {
                            if (set.weight && set.reps) {
                                logs.push({
                                    exerciseId: ex.id,
                                    exerciseName: ex.name,
                                    weight: set.weight,
                                    reps: set.reps,
                                    date: new Date(date).toISOString() 
                                });
                            }
                        });
                    });
                }

                if (logs.length === 0) {
                    alert("Please enter at least one completed set.");
                    return;
                }

                onSave({ date, routineId, duration, logs });
                onClose();
            };

            const activeRoutine = Object.values(ROUTINES).find(r => r.id === routineId);

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/90 backdrop-blur-md animate-slide-up overflow-y-auto py-4">
                    <div className="bg-slate-900 w-full max-w-lg rounded-2xl shadow-2xl border border-slate-700 flex flex-col max-h-full">
                        <div className="p-4 border-b border-slate-800 flex justify-between items-center bg-slate-900/90 sticky top-0 z-10">
                            <h3 className="text-lg font-bold text-white">Log Past Workout</h3>
                            <button onClick={onClose} className="p-2 bg-slate-800 rounded-full text-slate-400 hover:text-white"><Icon name="x" size={20} /></button>
                        </div>
                        <form onSubmit={handleSubmit} className="flex-1 overflow-y-auto p-4 space-y-6">
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-[10px] text-slate-500 uppercase font-bold tracking-widest">Date</label><input required type="date" value={date} onChange={e => setDate(e.target.value)} className="w-full bg-slate-800 border border-slate-700 rounded-lg p-2 text-white mt-1 focus:border-amber-500 outline-none" /></div>
                                <div><label className="text-[10px] text-slate-500 uppercase font-bold tracking-widest">Duration (min)</label><input required type="number" value={duration} onChange={e => setDuration(e.target.value)} className="w-full bg-slate-800 border border-slate-700 rounded-lg p-2 text-white mt-1 focus:border-amber-500 outline-none" /></div>
                                <div className="col-span-2"><label className="text-[10px] text-slate-500 uppercase font-bold tracking-widest">Routine Template</label><select value={routineId} onChange={e => setRoutineId(e.target.value)} className="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white mt-1 focus:border-amber-500 outline-none font-bold">{Object.values(ROUTINES).map(r => (<option key={r.id} value={r.id}>{r.title}</option>))}</select></div>
                            </div>
                            <hr className="border-slate-800" />
                            <div className="space-y-6">
                                {activeRoutine && activeRoutine.exercises.map(ex => (
                                    <div key={ex.id} className="bg-slate-950/50 rounded-xl p-3 border border-slate-800/50">
                                        <div className="flex justify-between items-center mb-2"><h4 className="font-bold text-slate-200 text-sm">{ex.name}</h4><span className="text-[10px] text-slate-500 font-mono">{ex.sets} Sets Goal</span></div>
                                        <div className="space-y-2">
                                            {entryData[ex.id] && entryData[ex.id].map((set, idx) => (
                                                <div key={idx} className="flex items-center gap-2"><span className="text-xs text-slate-600 font-mono w-4">{idx + 1}</span><input type="number" placeholder="Lbs" value={set.weight} onChange={(e) => handleSetChange(ex.id, idx, 'weight', e.target.value)} className="flex-1 bg-slate-900 border border-slate-700 rounded px-3 py-2 text-sm text-white focus:border-amber-500 outline-none" /><input type="number" placeholder="Reps" value={set.reps} onChange={(e) => handleSetChange(ex.id, idx, 'reps', e.target.value)} className="flex-1 bg-slate-900 border border-slate-700 rounded px-3 py-2 text-sm text-white focus:border-amber-500 outline-none" /><button type="button" onClick={() => removeSet(ex.id, idx)} className="p-2 text-slate-600 hover:text-red-500"><Icon name="trash" size={14} /></button></div>
                                            ))}
                                            <button type="button" onClick={() => addSet(ex.id)} className="w-full py-1.5 text-xs font-bold text-amber-500/70 hover:text-amber-500 hover:bg-slate-900 rounded border border-dashed border-slate-700 mt-2 transition-colors">+ Add Set</button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </form>
                        <div className="p-4 border-t border-slate-800 bg-slate-900 sticky bottom-0 z-10">
                            <button onClick={handleSubmit} className="w-full bg-amber-500 text-slate-900 font-bold py-3 rounded-xl hover:bg-amber-400 transition-colors shadow-lg shadow-amber-500/20">Save Workout Log</button>
                        </div>
                    </div>
                </div>
            );
        };

        // 5. REUSABLE CONFIRMATION MODAL
        const ConfirmModal = ({ isOpen, onClose, onConfirm, title="Confirm Action", message, confirmLabel="Confirm", confirmColor="bg-red-500" }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-slide-up">
                    <div className="bg-slate-900 border border-slate-700 w-full max-w-sm rounded-2xl p-6 shadow-2xl">
                        <h3 className="text-xl font-bold text-white mb-2">{title}</h3>
                        <p className="text-slate-400 mb-6">{message}</p>
                        <div className="flex gap-3">
                            <button onClick={onClose} className="flex-1 py-3 rounded-xl bg-slate-800 text-white font-bold hover:bg-slate-700 transition-colors">Cancel</button>
                            <button onClick={onConfirm} className={`flex-1 py-3 rounded-xl text-slate-900 font-bold transition-colors ${confirmColor}`}>{confirmLabel}</button>
                        </div>
                    </div>
                </div>
            );
        }

        // 6. WORKOUT DETAIL MODAL
        const WorkoutDetailModal = ({ session, onClose }) => {
            if (!session) return null;

            // Group logs by exercise
            const groupedLogs = useMemo(() => {
                if (!session.logs || session.logs.length === 0) return {};
                const groups = {};
                session.logs.forEach(log => {
                    const key = log.exerciseName || 'Unknown Exercise'; 
                    if (!groups[key]) {
                        groups[key] = [];
                    }
                    groups[key].push(log);
                });
                return groups;
            }, [session]);

            return (
                <div className="fixed inset-0 z-[80] flex items-center justify-center bg-black/90 backdrop-blur-md animate-slide-up p-4">
                     <div className="bg-slate-900 w-full max-w-lg rounded-2xl shadow-2xl border border-slate-700 flex flex-col max-h-full overflow-hidden">
                        {/* Header */}
                        <div className="p-4 border-b border-slate-800 flex justify-between items-start bg-slate-900/90 sticky top-0 z-10">
                            <div>
                                <h3 className="text-xl font-bold text-white">{session.routineName}</h3>
                                <p className="text-sm text-slate-400">{new Date(session.endTime).toLocaleDateString()} • {formatDuration(session.duration)}</p>
                            </div>
                            <button onClick={onClose} className="p-2 bg-slate-800 rounded-full text-slate-400 hover:text-white">
                                <Icon name="x" size={20} />
                            </button>
                        </div>
                        
                        {/* Content */}
                        <div className="flex-1 overflow-y-auto p-4 space-y-4">
                            {Object.keys(groupedLogs).length === 0 ? (
                                 <div className="text-center text-slate-500 py-8">No detailed logs available for this session.</div>
                            ) : (
                                Object.entries(groupedLogs).map(([name, sets], i) => (
                                    <div key={i} className="bg-slate-950/50 rounded-xl p-4 border border-slate-800/50">
                                        <h4 className="font-bold text-slate-200 mb-3">{name}</h4>
                                        <div className="space-y-2">
                                            {sets.map((set, idx) => (
                                                <div key={idx} className="flex justify-between items-center text-sm border-b border-slate-800/50 last:border-0 pb-2 last:pb-0">
                                                    <span className="text-slate-500 font-mono w-8">#{idx + 1}</span>
                                                    <div className="flex gap-6">
                                                        <span className="text-slate-300"><span className="text-slate-500 text-xs uppercase mr-1">lbs</span>{set.weight}</span>
                                                        <span className="text-slate-300"><span className="text-slate-500 text-xs uppercase mr-1">reps</span>{set.reps}</span>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                     </div>
                </div>
            );
        };

        // 7. STATS TAB
        const StatsTab = ({ sessions, onDelete, onAddManual }) => {
            const [isEntryModalOpen, setIsEntryModalOpen] = useState(false);
            const [deleteId, setDeleteId] = useState(null);
            const [selectedSession, setSelectedSession] = useState(null); // For viewing details

            const totalPounds = sessions.reduce((acc, session) => {
                if (session.manualVolume) return acc + parseInt(session.manualVolume);
                if (!session.logs) return acc;
                return acc + session.logs.reduce((sAcc, log) => sAcc + (parseInt(log.weight || 0) * parseInt(log.reps || 0)), 0);
            }, 0);

            const requestDelete = (e, id) => {
                e.stopPropagation(); 
                setDeleteId(id);
            };

            const confirmDelete = () => {
                if (deleteId) {
                    onDelete(deleteId);
                    setDeleteId(null);
                }
            };

            return (
                <div className="space-y-6 animate-slide-up pb-24">
                    <ManualEntryModal isOpen={isEntryModalOpen} onClose={() => setIsEntryModalOpen(false)} onSave={onAddManual} />
                    
                    <ConfirmModal 
                        isOpen={!!deleteId} 
                        onClose={() => setDeleteId(null)} 
                        onConfirm={confirmDelete}
                        title="Delete Log"
                        message="Are you sure you want to delete this entry? This cannot be undone." 
                        confirmLabel="Delete"
                        confirmColor="bg-red-500 text-white"
                    />

                    <WorkoutDetailModal 
                        session={selectedSession} 
                        onClose={() => setSelectedSession(null)} 
                    />

                    <div className="grid grid-cols-2 gap-3">
                        <div className="glass-card p-4 rounded-2xl text-center"><p className="text-[10px] uppercase tracking-widest text-slate-400 font-bold mb-1">Workouts</p><p className="text-3xl font-black text-white">{sessions.length}</p></div>
                        <div className="glass-card p-4 rounded-2xl text-center"><p className="text-[10px] uppercase tracking-widest text-slate-400 font-bold mb-1">Total Lbs</p><p className="text-3xl font-black text-amber-500">{(totalPounds / 1000).toFixed(1)}k</p></div>
                    </div>

                    <button onClick={() => setIsEntryModalOpen(true)} className="w-full py-3 border border-dashed border-slate-600 rounded-xl text-slate-400 text-sm font-bold hover:border-amber-500 hover:text-amber-500 transition-all flex items-center justify-center gap-2"><Icon name="plus-circle" size={16} /> Log Past Workout</button>

                    <div>
                        <h3 className="text-slate-300 font-bold text-sm uppercase tracking-wider mb-3 ml-1">History</h3>
                        {sessions.length === 0 ? (
                            <div className="text-center py-10 text-slate-600 italic bg-slate-900/30 rounded-xl border border-dashed border-slate-800">No workouts completed yet.</div>
                        ) : (
                            <div className="space-y-3">
                                {[...sessions].reverse().map((session) => {
                                    const setsCount = session.logs ? session.logs.length : (session.manualSets || 0);
                                    const uniqueExercises = session.logs ? [...new Set(session.logs.map(l => l.exerciseName))] : [];
                                    return (
                                        <div 
                                            key={session.id} 
                                            onClick={() => setSelectedSession(session)}
                                            className="glass-card p-4 rounded-xl border-l-4 border-l-amber-500/50 relative group cursor-pointer hover:border-slate-500 transition-all active:scale-[0.98]"
                                        >
                                            <button onClick={(e) => requestDelete(e, session.id)} className="absolute top-4 right-4 z-30 text-slate-600 hover:text-red-500 p-2 rounded-full hover:bg-slate-800 transition-colors"><Icon name="trash-2" size={16} /></button>
                                            <div className="flex justify-between items-start mb-3 pr-8">
                                                <div><h4 className="text-white font-bold">{session.routineName || 'Workout'}</h4><p className="text-xs text-slate-500">{new Date(session.endTime).toLocaleDateString()} • {session.manual ? 'Manual Entry' : new Date(session.endTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p></div>
                                                <div className="text-right"><span className="block font-mono text-amber-400 text-sm font-bold">{formatDuration(session.duration)}</span><span className="text-[10px] text-slate-500 uppercase font-bold">{setsCount} Sets</span></div>
                                            </div>
                                            <div className="flex flex-wrap gap-1.5">
                                                {uniqueExercises.slice(0, 3).map((name, i) => (<span key={i} className="text-[9px] bg-slate-800 text-slate-400 px-2 py-0.5 rounded border border-slate-700/50 truncate max-w-[100px]">{name}</span>))}
                                                {uniqueExercises.length > 3 && (<span className="text-[9px] text-slate-500 px-1 py-0.5">+more</span>)}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---

        const App = () => {
            const [activeTab, setActiveTab] = useState('workout_a');
            const [sessions, setSessions] = useState([]);
            const [isWorkoutActive, setIsWorkoutActive] = useState(false);
            const [sessionStartTime, setSessionStartTime] = useState(null);
            const [currentSessionLogs, setCurrentSessionLogs] = useState([]);
            const [showRestTimer, setShowRestTimer] = useState(false);
            const [restTimerTrigger, setRestTimerTrigger] = useState(null);

            // Confirmation States
            const [showFinishConfirm, setShowFinishConfirm] = useState(false);
            const [showDiscardConfirm, setShowDiscardConfirm] = useState(false);

            useEffect(() => {
                const savedSessions = localStorage.getItem('iron_bell_sessions');
                if (savedSessions) setSessions(JSON.parse(savedSessions));
                const activeSession = localStorage.getItem('iron_bell_active_session');
                if (activeSession) {
                    const parsed = JSON.parse(activeSession);
                    if (Date.now() - parsed.startTime > 14400000) localStorage.removeItem('iron_bell_active_session');
                    else { setIsWorkoutActive(true); setSessionStartTime(parsed.startTime); setCurrentSessionLogs(parsed.logs); }
                }
            }, []);

            useEffect(() => {
                if (isWorkoutActive) localStorage.setItem('iron_bell_active_session', JSON.stringify({ startTime: sessionStartTime, logs: currentSessionLogs }));
                else localStorage.removeItem('iron_bell_active_session');
            }, [isWorkoutActive, currentSessionLogs, sessionStartTime]);

            const startWorkout = () => { const now = Date.now(); setIsWorkoutActive(true); setSessionStartTime(now); setCurrentSessionLogs([]); };

            // REPLACED: Logic to trigger modals instead of window.confirm
            const handleFinishClick = () => {
                if (currentSessionLogs.length === 0) {
                    setShowDiscardConfirm(true);
                } else {
                    setShowFinishConfirm(true);
                }
            };

            const performFinish = () => {
                const endTime = Date.now();
                const duration = endTime - sessionStartTime;
                const routineName = ROUTINES[activeTab.toUpperCase()]?.title || 'Custom Workout';
                const newSession = { id: `sess_${endTime}`, startTime: sessionStartTime, endTime, duration, routineName, logs: currentSessionLogs, manual: false };
                saveSession(newSession);
                
                // Reset states
                setIsWorkoutActive(false); 
                setSessionStartTime(null); 
                setCurrentSessionLogs([]); 
                setShowFinishConfirm(false);
                setActiveTab('stats'); 
            };

            const performDiscard = () => {
                setIsWorkoutActive(false); 
                setSessionStartTime(null); 
                setCurrentSessionLogs([]); 
                setShowDiscardConfirm(false);
            };

            const logExercise = (exerciseId, data) => {
                const newLog = { exerciseId, ...data, date: new Date().toISOString() };
                setCurrentSessionLogs(prev => [...prev, newLog]); setRestTimerTrigger(Date.now()); setShowRestTimer(true);
            };

            const addManualSession = (data) => {
                const endTime = new Date(data.date).getTime() + 43200000;
                const routineTitle = Object.values(ROUTINES).find(r => r.id === data.routineId)?.title || 'Manual Workout';
                const newSession = { id: `manual_${Date.now()}`, startTime: endTime - (data.duration * 60000), endTime: endTime, duration: data.duration * 60000, routineName: routineTitle, logs: data.logs, manual: true };
                saveSession(newSession);
            };

            const deleteSession = (id) => {
                const updatedSessions = sessions.filter(s => s.id !== id);
                setSessions(updatedSessions);
                localStorage.setItem('iron_bell_sessions', JSON.stringify(updatedSessions));
            };

            const saveSession = (session) => {
                const updatedSessions = [...sessions, session];
                updatedSessions.sort((a, b) => a.endTime - b.endTime);
                setSessions(updatedSessions);
                localStorage.setItem('iron_bell_sessions', JSON.stringify(updatedSessions));
            };

            const currentRoutine = Object.values(ROUTINES).find(r => r.id === activeTab) || ROUTINES.WORKOUT_A;

            return (
                <div className="min-h-screen flex flex-col bg-[#0f172a] text-slate-200 pb-0 relative overflow-hidden">
                    
                    {/* Confirmation Modals */}
                    <ConfirmModal
                        isOpen={showFinishConfirm}
                        onClose={() => setShowFinishConfirm(false)}
                        onConfirm={performFinish}
                        title="Finish Workout"
                        message="Are you ready to finish this workout and save your stats?"
                        confirmLabel="Finish & Save"
                        confirmColor="bg-amber-500 text-slate-900"
                    />

                    <ConfirmModal
                        isOpen={showDiscardConfirm}
                        onClose={() => setShowDiscardConfirm(false)}
                        onConfirm={performDiscard}
                        title="Discard Workout"
                        message="No sets were logged. Do you want to discard this empty session?"
                        confirmLabel="Discard"
                        confirmColor="bg-red-500 text-white"
                    />

                    <div className="pt-12 pb-4 px-6 sticky top-0 z-30 glass-panel shadow-2xl">
                        <div className="flex justify-between items-start">
                            <div><h1 className="text-2xl font-black tracking-tighter text-white leading-none">IRON <span className="text-amber-500">&</span> BELL</h1><p className="text-[10px] text-slate-400 font-bold tracking-widest uppercase mt-1">Scientific Strength Protocol</p></div>
                            <div className="flex flex-col items-end gap-2">{isWorkoutActive ? (<SessionTimer startTime={sessionStartTime} />) : (<div className="text-[10px] font-bold text-slate-500 uppercase py-1">Not Active</div>)}</div>
                        </div>
                        {activeTab !== 'stats' && (
                            <div className="mt-4">
                                {!isWorkoutActive ? (
                                    <button onClick={startWorkout} className="w-full py-3 rounded-xl bg-amber-500 hover:bg-amber-400 text-slate-950 font-black tracking-wide uppercase shadow-[0_0_20px_rgba(245,158,11,0.3)] transition-all active:scale-[0.98] flex items-center justify-center gap-2"><Icon name="play" size={18} fill="currentColor" /> Start Workout</button>
                                ) : (
                                    <button onClick={handleFinishClick} className="w-full py-3 rounded-xl bg-slate-800 border border-slate-600 text-white font-bold tracking-wide uppercase hover:bg-slate-700 transition-all active:scale-[0.98] flex items-center justify-center gap-2"><Icon name="flag" size={18} /> Finish Workout</button>
                                )}
                            </div>
                        )}
                    </div>
                    <div className="flex-1 px-4 pt-6 pb-24 overflow-y-auto no-scrollbar">
                        {activeTab === 'stats' ? (
                            <StatsTab sessions={sessions} onDelete={deleteSession} onAddManual={addManualSession} />
                        ) : (
                            <div className="animate-slide-up">
                                <div className="mb-6"><h2 className="text-2xl font-bold text-white">{currentRoutine.title}</h2><p className="text-slate-400 text-sm">{currentRoutine.subtitle}</p></div>
                                <div className="space-y-2 pb-8">{currentRoutine.exercises.map((ex) => (<ExerciseCard key={ex.id} exercise={ex} logs={currentSessionLogs} onLog={logExercise} isWorkoutActive={isWorkoutActive} />))}</div>
                            </div>
                        )}
                    </div>
                    <RestTimer isOpen={showRestTimer} onClose={() => setShowRestTimer(false)} autoStartTrigger={restTimerTrigger} />
                    {!isWorkoutActive && (
                        <div className="fixed bottom-0 left-0 right-0 bg-[#0f172a]/95 backdrop-blur-lg border-t border-white/10 pb-safe pt-2 px-2 z-40">
                            <div className="flex justify-around items-center h-16">
                                <button onClick={() => setActiveTab('warmup')} className={`flex flex-col items-center justify-center w-16 h-full ${activeTab === 'warmup' ? 'active-tab' : 'text-slate-500'}`}><Icon name="sun" size={20} /><span className="text-[9px] font-bold uppercase mt-1">Warmup</span></button>
                                <button onClick={() => setActiveTab('workout_a')} className={`flex flex-col items-center justify-center w-16 h-full ${activeTab === 'workout_a' ? 'active-tab' : 'text-slate-500'}`}><Icon name="dumbbell" size={20} /><span className="text-[9px] font-bold uppercase mt-1">A</span></button>
                                <button onClick={() => setActiveTab('workout_b')} className={`flex flex-col items-center justify-center w-16 h-full ${activeTab === 'workout_b' ? 'active-tab' : 'text-slate-500'}`}><Icon name="biceps-flexed" size={20} /><span className="text-[9px] font-bold uppercase mt-1">B</span></button>
                                <button onClick={() => setActiveTab('stats')} className={`flex flex-col items-center justify-center w-16 h-full ${activeTab === 'stats' ? 'active-tab' : 'text-slate-500'}`}><Icon name="bar-chart-2" size={20} /><span className="text-[9px] font-bold uppercase mt-1">Stats</span></button>
                            </div>
                        </div>
                    )}
                    {isWorkoutActive && (
                        <div className="fixed bottom-0 left-0 right-0 bg-amber-500 text-slate-900 p-3 text-center font-bold uppercase text-xs tracking-widest z-40 flex justify-center items-center gap-2"><span className="w-2 h-2 bg-slate-900 rounded-full animate-pulse"></span>Workout in Progress</div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
