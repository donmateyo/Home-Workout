<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#0F1419">
    <meta name="description" content="Premium Strength Training Companion - Progressive workout tracking with minimal equipment">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Strength Training Companion</title>

    <!-- PWA Manifest -->
    <link rel="manifest" id="manifest-placeholder">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'primary-bg': '#0F1419',
                        'secondary-bg': '#1A1F2E',
                        'accent': '#2D5A7B',
                        'accent-hover': '#1B4965',
                        'text-primary': '#E8E8E8',
                        'text-secondary': '#A0A0A0',
                        'success': '#5A8C6E',
                        'warning': '#C89D5C',
                    }
                }
            }
        }
    </script>

    <style>
        * {
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .touch-target {
            min-height: 44px;
            min-width: 44px;
        }

        @keyframes pulse-success {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulse-success {
            animation: pulse-success 1s ease-in-out;
        }

        .timer-circle {
            transition: stroke-dashoffset 1s linear;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"] {
            -moz-appearance: textfield;
        }

        .gradient-border {
            position: relative;
            background: linear-gradient(135deg, #2D5A7B 0%, #1B4965 100%);
            padding: 2px;
            border-radius: 12px;
        }

        .gradient-border-inner {
            background: #1A1F2E;
            border-radius: 10px;
        }
    </style>
</head>
<body class="dark bg-primary-bg text-text-primary min-h-screen">

    <div id="app" class="pb-20"></div>

    <!-- Bottom Navigation -->
    <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 bg-secondary-bg border-t border-gray-800 safe-area-inset-bottom z-50">
        <div class="flex justify-around items-center h-16">
            <button onclick="app.navigate('home')" class="nav-item flex flex-col items-center justify-center flex-1 touch-target" data-page="home">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                </svg>
                <span class="text-xs">Home</span>
            </button>

            <button onclick="app.navigate('workouts')" class="nav-item flex flex-col items-center justify-center flex-1 touch-target" data-page="workouts">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                </svg>
                <span class="text-xs">Workouts</span>
            </button>

            <button onclick="app.navigate('exercises')" class="nav-item flex flex-col items-center justify-center flex-1 touch-target" data-page="exercises">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                </svg>
                <span class="text-xs">Exercises</span>
            </button>

            <button onclick="app.navigate('progress')" class="nav-item flex flex-col items-center justify-center flex-1 touch-target" data-page="progress">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                <span class="text-xs">Progress</span>
            </button>

            <button onclick="app.navigate('settings')" class="nav-item flex flex-col items-center justify-center flex-1 touch-target" data-page="settings">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <span class="text-xs">Settings</span>
            </button>
        </div>
    </nav>

    <script>
        class Database {
            constructor() {
                this.dbName = 'StrengthTrainingDB';
                this.version = 1;
                this.db = null;
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);

                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve(this.db);
                    };

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;

                        if (!db.objectStoreNames.contains('exercises')) {
                            db.createObjectStore('exercises', { keyPath: 'id', autoIncrement: true });
                        }

                        if (!db.objectStoreNames.contains('workouts')) {
                            db.createObjectStore('workouts', { keyPath: 'id', autoIncrement: true });
                        }

                        if (!db.objectStoreNames.contains('history')) {
                            const historyStore = db.createObjectStore('history', { keyPath: 'id', autoIncrement: true });
                            historyStore.createIndex('date', 'date', { unique: false });
                            historyStore.createIndex('workoutId', 'workoutId', { unique: false });
                        }

                        if (!db.objectStoreNames.contains('exerciseHistory')) {
                            const exHistoryStore = db.createObjectStore('exerciseHistory', { keyPath: 'id', autoIncrement: true });
                            exHistoryStore.createIndex('exerciseId', 'exerciseId', { unique: false });
                            exHistoryStore.createIndex('date', 'date', { unique: false });
                        }

                        if (!db.objectStoreNames.contains('settings')) {
                            db.createObjectStore('settings', { keyPath: 'key' });
                        }
                    };
                });
            }

            async add(storeName, data) {
                const tx = this.db.transaction(storeName, 'readwrite');
                const store = tx.objectStore(storeName);
                return new Promise((resolve, reject) => {
                    const request = store.add(data);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async put(storeName, data) {
                const tx = this.db.transaction(storeName, 'readwrite');
                const store = tx.objectStore(storeName);
                return new Promise((resolve, reject) => {
                    const request = store.put(data);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async get(storeName, id) {
                const tx = this.db.transaction(storeName, 'readonly');
                const store = tx.objectStore(storeName);
                return new Promise((resolve, reject) => {
                    const request = store.get(id);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async getAll(storeName) {
                const tx = this.db.transaction(storeName, 'readonly');
                const store = tx.objectStore(storeName);
                return new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async delete(storeName, id) {
                const tx = this.db.transaction(storeName, 'readwrite');
                const store = tx.objectStore(storeName);
                return new Promise((resolve, reject) => {
                    const request = store.delete(id);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }

            async getByIndex(storeName, indexName, value) {
                const tx = this.db.transaction(storeName, 'readonly');
                const store = tx.objectStore(storeName);
                const index = store.index(indexName);
                return new Promise((resolve, reject) => {
                    const request = index.getAll(value);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async clear(storeName) {
                const tx = this.db.transaction(storeName, 'readwrite');
                const store = tx.objectStore(storeName);
                return new Promise((resolve, reject) => {
                    const request = store.clear();
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }
        }

        const EXERCISE_DATABASE = [
            {
                name: 'Bodyweight Squat',
                category: 'Lower Body',
                equipment: ['bodyweight'],
                formCues: [
                    'Feet shoulder-width apart, toes slightly out',
                    'Keep chest up and core braced throughout',
                    'Push knees out as you descend, tracking over toes',
                    'Descend until thighs parallel or below, maintaining heel contact',
                    'Drive through full foot to stand'
                ],
                repRange: [12, 20],
                movementType: 'compound',
                difficulty: 'beginner',
                progressionPath: 'Bulgarian Split Squat'
            },
            {
                name: 'Bulgarian Split Squat',
                category: 'Lower Body',
                equipment: ['bodyweight'],
                formCues: [
                    'Rear foot elevated on stable surface (knee height)',
                    'Front foot far enough forward to keep knee behind toes',
                    'Torso upright, core engaged',
                    'Lower until front thigh parallel, knee tracks over middle toes',
                    'Drive through front heel to return'
                ],
                repRange: [8, 15],
                movementType: 'compound',
                difficulty: 'intermediate',
                progressionPath: 'Dumbbell Bulgarian Split Squat'
            },
            {
                name: 'Dumbbell Bulgarian Split Squat',
                category: 'Lower Body',
                equipment: ['dumbbell_25'],
                formCues: [
                    'Hold dumbbells at sides with neutral grip',
                    'Rear foot elevated, front foot positioned for vertical shin at bottom',
                    'Maintain upright torso, avoid leaning forward',
                    'Control descent to parallel or slightly below',
                    'Drive explosively through front leg'
                ],
                repRange: [8, 12],
                movementType: 'compound',
                difficulty: 'intermediate',
                progressionPath: 'Heavy Dumbbell Bulgarian Split Squat'
            },
            {
                name: 'Heavy Dumbbell Bulgarian Split Squat',
                category: 'Lower Body',
                equipment: ['dumbbell_35'],
                formCues: [
                    'Use heavier dumbbells at sides',
                    'Focus on eccentric control (3-4 second descent)',
                    'Maintain perfect form despite added load',
                    'Drive powerfully through front heel',
                    'Squeeze glute at top of movement'
                ],
                repRange: [6, 10],
                movementType: 'compound',
                difficulty: 'advanced',
                progressionPath: null
            },
            {
                name: 'Walking Lunge',
                category: 'Lower Body',
                equipment: ['bodyweight'],
                formCues: [
                    'Step forward with long stride',
                    'Lower back knee toward ground without touching',
                    'Keep front shin vertical, knee behind toes',
                    'Torso upright throughout movement',
                    'Push through front heel to step into next lunge'
                ],
                repRange: [10, 16],
                movementType: 'compound',
                difficulty: 'beginner',
                progressionPath: 'Dumbbell Walking Lunge'
            },
            {
                name: 'Dumbbell Walking Lunge',
                category: 'Lower Body',
                equipment: ['dumbbell_25'],
                formCues: [
                    'Hold dumbbells at sides, shoulders back',
                    'Take controlled step forward into lunge',
                    'Back knee descends to just above ground',
                    'Maintain upright posture, core tight',
                    'Drive through front foot to next step'
                ],
                repRange: [8, 12],
                movementType: 'compound',
                difficulty: 'intermediate',
                progressionPath: 'Heavy Dumbbell Walking Lunge'
            },
            {
                name: 'Heavy Dumbbell Walking Lunge',
                category: 'Lower Body',
                equipment: ['dumbbell_35'],
                formCues: [
                    'Use heavier dumbbells, focus on stability',
                    'Controlled eccentric, explosive concentric',
                    'Keep torso perfectly upright',
                    'Step length consistent throughout set',
                    'Reset breathing between reps if needed'
                ],
                repRange: [6, 10],
                movementType: 'compound',
                difficulty: 'advanced',
                progressionPath: null
            },
            {
                name: 'Single-Leg Romanian Deadlift',
                category: 'Lower Body',
                equipment: ['bodyweight'],
                formCues: [
                    'Stand on one leg, slight knee bend',
                    'Hinge at hips, extending free leg behind for balance',
                    'Maintain neutral spine, chest up',
                    'Lower until torso parallel or slight hamstring stretch',
                    'Squeeze glute to return to standing'
                ],
                repRange: [8, 15],
                movementType: 'compound',
                difficulty: 'intermediate',
                progressionPath: 'Dumbbell Single-Leg RDL'
            },
            {
                name: 'Dumbbell Single-Leg RDL',
                category: 'Lower Body',
                equipment: ['dumbbell_25'],
                formCues: [
                    'Hold dumbbell in opposite hand of standing leg',
                    'Hinge at hips, keeping loaded side arm extended',
                    'Back stays flat, free leg extends behind',
                    'Feel stretch in hamstring of standing leg',
                    'Drive hips forward to return'
                ],
                repRange: [8, 12],
                movementType: 'compound',
                difficulty: 'intermediate',
                progressionPath: 'Heavy Dumbbell Single-Leg RDL'
            },
            {
                name: 'Heavy Dumbbell Single-Leg RDL',
                category: 'Lower Body',
                equipment: ['dumbbell_35'],
                formCues: [
                    'Use heavier dumbbell, prioritize control',
                    'Slow eccentric (3 seconds down)',
                    'Maintain perfect balance and neutral spine',
                    'Full hip extension at top with glute squeeze',
                    'Free hand can touch wall lightly for balance if needed'
                ],
                repRange: [6, 10],
                movementType: 'compound',
                difficulty: 'advanced',
                progressionPath: null
            },
            {
                name: 'Glute Bridge',
                category: 'Lower Body',
                equipment: ['bodyweight'],
                formCues: [
                    'Lie on back, feet flat, heels close to glutes',
                    'Drive through heels, lifting hips toward ceiling',
                    'Squeeze glutes hard at top, avoid arching lower back',
                    'Shoulders stay on ground, knees track over toes',
                    'Control descent without resting on ground'
                ],
                repRange: [15, 25],
                movementType: 'isolation',
                difficulty: 'beginner',
                progressionPath: 'Single-Leg Glute Bridge'
            },
            {
                name: 'Single-Leg Glute Bridge',
                category: 'Lower Body',
                equipment: ['bodyweight'],
                formCues: [
                    'One foot flat, extend other leg straight',
                    'Drive through planted heel',
                    'Keep hips level, dont rotate',
                    'Maximum glute squeeze at top',
                    'Extended leg remains elevated throughout'
                ],
                repRange: [10, 20],
                movementType: 'isolation',
                difficulty: 'intermediate',
                progressionPath: 'Dumbbell Glute Bridge'
            },
            {
                name: 'Dumbbell Glute Bridge',
                category: 'Lower Body',
                equipment: ['dumbbell_25'],
                formCues: [
                    'Place dumbbell across hips, hold with both hands',
                    'Feet flat, shoulder-width apart',
                    'Drive hips up, focusing on glute contraction',
                    'Hold top position for 1-2 seconds',
                    'Lower with control, maintain dumbbell position'
                ],
                repRange: [12, 20],
                movementType: 'isolation',
                difficulty: 'intermediate',
                progressionPath: 'Heavy Dumbbell Glute Bridge'
            },
            {
                name: 'Push-Up',
                category: 'Upper Body Push',
                equipment: ['bodyweight'],
                formCues: [
                    'Hands slightly wider than shoulders, fingers forward',
                    'Body forms straight line from head to heels',
                    'Lower chest to ground, elbows 45Â° from body',
                    'Keep core tight, dont let hips sag',
                    'Press explosively to full arm extension'
                ],
                repRange: [10, 20],
                movementType: 'compound',
                difficulty: 'beginner',
                progressionPath: 'Diamond Push-Up'
            },
            {
                name: 'Diamond Push-Up',
                category: 'Upper Body Push',
                equipment: ['bodyweight'],
                formCues: [
                    'Hands together forming diamond shape with thumbs and index fingers',
                    'Positioned directly under chest',
                    'Elbows tuck close to ribs as you descend',
                    'Greater tricep emphasis than regular push-up',
                    'Maintain rigid body alignment'
                ],
                repRange: [8, 15],
                movementType: 'compound',
                difficulty: 'intermediate',
                progressionPath: 'Archer Push-Up'
            },
            {
                name: 'Archer Push-Up',
                category: 'Upper Body Push',
                equipment: ['bodyweight'],
                formCues: [
                    'Hands wider than shoulders',
                    'Shift weight to one side as you descend',
                    'Working arm bends, opposite arm stays mostly straight',
                    'Lower chest toward working hand',
                    'Push back to center, alternate sides'
                ],
                repRange: [6, 12],
                movementType: 'compound',
                difficulty: 'advanced',
                progressionPath: null
            },
            {
                name: 'Dumbbell Floor Press',
                category: 'Upper Body Push',
                equipment: ['dumbbell_25'],
                formCues: [
                    'Lie on back, knees bent, feet flat',
                    'Dumbbells at chest level, elbows resting on floor',
                    'Press dumbbells up until arms extended',
                    'Lower with control until triceps touch floor',
                    'Brief pause on floor, then press'
                ],
                repRange: [8, 15],
                movementType: 'compound',
                difficulty: 'intermediate',
                progressionPath: 'Heavy Dumbbell Floor Press'
            },
            {
                name: 'Heavy Dumbbell Floor Press',
                category: 'Upper Body Push',
                equipment: ['dumbbell_35'],
                formCues: [
                    'Use heavier dumbbells, setup same as standard floor press',
                    'Slow eccentric (3 seconds down)',
                    'Pause on floor with muscles engaged',
                    'Explosive press to lockout',
                    'Maintain shoulder blade retraction throughout'
                ],
                repRange: [6, 10],
                movementType: 'compound',
                difficulty: 'advanced',
                progressionPath: null
            },
            {
                name: 'Dumbbell Shoulder Press',
                category: 'Upper Body Push',
                equipment: ['dumbbell_25'],
                formCues: [
                    'Standing or seated, dumbbells at shoulder height',
                    'Elbows slightly in front of shoulders',
                    'Press dumbbells overhead to full extension',
                    'Bring dumbbells close together at top (not touching)',
                    'Lower with control to shoulder height'
                ],
                repRange: [8, 15],
                movementType: 'compound',
                difficulty: 'intermediate',
                progressionPath: 'Heavy Dumbbell Shoulder Press'
            },
            {
                name: 'Heavy Dumbbell Shoulder Press',
                category: 'Upper Body Push',
                equipment: ['dumbbell_35'],
                formCues: [
                    'Heavier dumbbells, strict form essential',
                    'Avoid leaning back excessively',
                    'Core tight to protect lower back',
                    'Controlled tempo both directions',
                    'Full range of motion, shoulder to overhead'
                ],
                repRange: [6, 10],
                movementType: 'compound',
                difficulty: 'advanced',
                progressionPath: null
            },
            {
                name: 'Kettlebell Row (2-Arm)',
                category: 'Upper Body Pull',
                equipment: ['kettlebell_50'],
                formCues: [
                    'Hold kettlebell in one hand, hinge at hips',
                    'Free hand on bench or elevated surface for support',
                    'Pull kettlebell to hip, elbow close to body',
                    'Squeeze shoulder blade back at top',
                    'Lower with control, full arm extension'
                ],
                repRange: [10, 15],
                movementType: 'compound',
                difficulty: 'beginner',
                progressionPath: 'Heavy Kettlebell Row'
            },
            {
                name: 'Heavy Kettlebell Row',
                category: 'Upper Body Pull',
                equipment: ['kettlebell_70'],
                formCues: [
                    'Heavier kettlebell, same setup',
                    'Focus on lat engagement, not just arm pull',
                    'Pause at top of each rep (1 second)',
                    'Prevent torso rotation',
                    'Maintain neutral spine throughout'
                ],
                repRange: [8, 12],
                movementType: 'compound',
                difficulty: 'intermediate',
                progressionPath: null
            },
            {
                name: 'Kettlebell Gorilla Row',
                category: 'Upper Body Pull',
                equipment: ['kettlebell_50', 'kettlebell_70'],
                formCues: [
                    'Two kettlebells on ground, feet wide stance',
                    'Hinge at hips, flat back, grab both kettlebells',
                    'Row one kettlebell to hip while stabilizing with other arm',
                    'Minimize torso rotation',
                    'Alternate arms each rep'
                ],
                repRange: [8, 12],
                movementType: 'compound',
                difficulty: 'intermediate',
                progressionPath: null
            },
            {
                name: 'Kettlebell Renegade Row',
                category: 'Upper Body Pull',
                equipment: ['kettlebell_50'],
                formCues: [
                    'Push-up position with hands on kettlebells',
                    'Feet wide for stability',
                    'Row one kettlebell while maintaining plank position',
                    'Prevent hip rotation and sagging',
                    'Alternate arms'
                ],
                repRange: [6, 12],
                movementType: 'compound',
                difficulty: 'advanced',
                progressionPath: 'Heavy Kettlebell Renegade Row'
            },
            {
                name: 'Plank',
                category: 'Core',
                equipment: ['bodyweight'],
                formCues: [
                    'Forearms on ground, elbows under shoulders',
                    'Body straight line, hips level',
                    'Squeeze glutes and brace core',
                    'Dont let hips sag or pike up',
                    'Breathe steadily, maintain tension'
                ],
                repRange: [30, 90],
                movementType: 'isolation',
                difficulty: 'beginner',
                progressionPath: 'RKC Plank'
            },
            {
                name: 'RKC Plank',
                category: 'Core',
                equipment: ['bodyweight'],
                formCues: [
                    'Plank position with forearms further forward',
                    'Maximum posterior pelvic tilt',
                    'Squeeze everything: glutes, quads, core, lats',
                    'Short, intense holds (10-20 sec)',
                    'Focus on total body tension'
                ],
                repRange: [10, 30],
                movementType: 'isolation',
                difficulty: 'advanced',
                progressionPath: null
            },
            {
                name: 'Dead Bug',
                category: 'Core',
                equipment: ['bodyweight'],
                formCues: [
                    'Lie on back, arms extended toward ceiling',
                    'Knees bent 90Â°, shins parallel to ground',
                    'Press lower back into floor',
                    'Extend opposite arm and leg simultaneously',
                    'Return to start, dont let back arch'
                ],
                repRange: [10, 20],
                movementType: 'isolation',
                difficulty: 'beginner',
                progressionPath: 'Dumbbell Dead Bug'
            },
            {
                name: 'Dumbbell Dead Bug',
                category: 'Core',
                equipment: ['dumbbell_25'],
                formCues: [
                    'Hold light dumbbells in hands',
                    'Same dead bug pattern, added resistance',
                    'Maintain lower back contact with floor',
                    'Slower tempo for increased time under tension',
                    'Exhale as you extend'
                ],
                repRange: [8, 15],
                movementType: 'isolation',
                difficulty: 'intermediate',
                progressionPath: null
            },
            {
                name: 'Pallof Press',
                category: 'Core',
                equipment: ['kettlebell_50'],
                formCues: [
                    'Stand perpendicular to anchor point, hold kettlebell at chest',
                    'Feet shoulder-width, knees slightly bent',
                    'Press kettlebell straight out from chest',
                    'Resist rotation, maintain square hips and shoulders',
                    'Return to chest with control'
                ],
                repRange: [10, 15],
                movementType: 'isolation',
                difficulty: 'intermediate',
                progressionPath: 'Heavy Pallof Press'
            },
            {
                name: 'Farmers Carry',
                category: 'Core',
                equipment: ['kettlebell_50', 'kettlebell_70'],
                formCues: [
                    'Hold heavy kettlebells at sides',
                    'Stand tall, shoulders packed down',
                    'Walk with controlled steps',
                    'Maintain upright posture, dont lean',
                    'Brace core throughout'
                ],
                repRange: [30, 60],
                movementType: 'compound',
                difficulty: 'intermediate',
                progressionPath: 'Uneven Farmers Carry'
            },
            {
                name: 'Burpee',
                category: 'Conditioning',
                equipment: ['bodyweight'],
                formCues: [
                    'Start standing, drop to push-up position',
                    'Perform full push-up (or step down if modified)',
                    'Jump feet to hands',
                    'Explosive jump with arms overhead',
                    'Land softly, immediately into next rep'
                ],
                repRange: [8, 20],
                movementType: 'compound',
                difficulty: 'intermediate',
                progressionPath: null
            },
            {
                name: 'Mountain Climber',
                category: 'Conditioning',
                equipment: ['bodyweight'],
                formCues: [
                    'High plank position',
                    'Drive one knee toward chest',
                    'Quickly switch legs in running motion',
                    'Keep hips level, dont pike up',
                    'Maintain rhythm and speed'
                ],
                repRange: [20, 40],
                movementType: 'compound',
                difficulty: 'beginner',
                progressionPath: null
            },
            {
                name: 'Jump Squat',
                category: 'Conditioning',
                equipment: ['bodyweight'],
                formCues: [
                    'Start in squat position',
                    'Explode upward, leaving ground',
                    'Land softly with bent knees',
                    'Immediately descend into next squat',
                    'Arms swing for momentum'
                ],
                repRange: [8, 15],
                movementType: 'compound',
                difficulty: 'intermediate',
                progressionPath: 'Dumbbell Jump Squat'
            },
            {
                name: 'Kettlebell Swing',
                category: 'Conditioning',
                equipment: ['kettlebell_50'],
                formCues: [
                    'Feet wider than shoulders, kettlebell between legs',
                    'Hinge at hips, slight knee bend',
                    'Explosive hip drive to swing kettlebell to chest/eye level',
                    'Movement comes from hips, not arms',
                    'Control descent, hinge back immediately'
                ],
                repRange: [12, 20],
                movementType: 'compound',
                difficulty: 'intermediate',
                progressionPath: 'Heavy Kettlebell Swing'
            },
            {
                name: 'Heavy Kettlebell Swing',
                category: 'Conditioning',
                equipment: ['kettlebell_70'],
                formCues: [
                    'Same form with heavier kettlebell',
                    'More forceful hip snap required',
                    'Maintain flat back throughout',
                    'Breathe forcefully with each rep',
                    'Power from glutes and hamstrings'
                ],
                repRange: [10, 15],
                movementType: 'compound',
                difficulty: 'advanced',
                progressionPath: null
            }
        ];

        class ProgressionEngine {
            constructor(db) {
                this.db = db;
            }

            async getRecentSessions(exerciseId, limit = 2) {
                const allHistory = await this.db.getByIndex('exerciseHistory', 'exerciseId', exerciseId);
                return allHistory.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, limit);
            }

            async suggestProgression(exerciseId, currentWeight, currentReps, currentSets, targetRepRange) {
                const recentSessions = await this.getRecentSessions(exerciseId, 2);

                if (recentSessions.length < 2) {
                    return {
                        type: 'none',
                        message: 'Complete at least 2 sessions to see progression suggestions'
                    };
                }

                const [lastSession, secondLastSession] = recentSessions;

                const lastSessionHitTarget = lastSession.sets.every(set => set.reps >= targetRepRange[1]);
                const secondLastHitTarget = secondLastSession.sets.every(set => set.reps >= targetRepRange[1]);

                if (lastSessionHitTarget && secondLastHitTarget) {
                    return {
                        type: 'weight',
                        message: `Great! You've hit ${targetRepRange[1]} reps for 2 sessions. Time to increase weight!`,
                        suggestion: 'Increase weight and aim for lower end of rep range',
                        badge: 'Weight Upgrade Available ðŸŽ¯'
                    };
                }

                const lastAvgReps = this.calculateAvgReps(lastSession.sets);
                const secondLastAvgReps = this.calculateAvgReps(secondLastSession.sets);

                if (lastAvgReps >= targetRepRange[0] && secondLastAvgReps >= targetRepRange[0] &&
                    lastAvgReps < targetRepRange[1]) {
                    return {
                        type: 'reps',
                        message: `Consistent performance! Add 1-2 reps next session.`,
                        suggestion: `Target ${Math.ceil(lastAvgReps) + 1}-${Math.ceil(lastAvgReps) + 2} reps`,
                        badge: 'Rep Progression Available ðŸ“ˆ'
                    };
                }

                const lastBelowMin = lastSession.sets.some(set => set.reps < targetRepRange[0]);
                const secondLastBelowMin = secondLastSession.sets.some(set => set.reps < targetRepRange[0]);

                if (lastBelowMin && secondLastBelowMin) {
                    return {
                        type: 'deload',
                        message: 'Consider reducing weight or reps by 10% to rebuild',
                        suggestion: 'Deload recommended',
                        badge: 'Deload Suggested âš ï¸'
                    };
                }

                return {
                    type: 'maintain',
                    message: 'Keep working at current weight/reps',
                    suggestion: 'Build consistency'
                };
            }

            calculateAvgReps(sets) {
                if (!sets || sets.length === 0) return 0;
                const totalReps = sets.reduce((sum, set) => sum + set.reps, 0);
                return totalReps / sets.length;
            }

            calculateSessionVolume(sets, weight) {
                return sets.reduce((total, set) => {
                    const weightValue = this.parseWeight(weight);
                    return total + (set.reps * weightValue);
                }, 0);
            }

            parseWeight(weight) {
                if (weight === 'bodyweight') return 150;
                if (weight === 'dumbbell_25') return 25;
                if (weight === 'dumbbell_35') return 35;
                if (weight === 'kettlebell_50') return 50;
                if (weight === 'kettlebell_70') return 70;
                return 0;
            }

            async getStrengthTrend(exerciseId) {
                const history = await this.getRecentSessions(exerciseId, 7);
                return history.map(session => ({
                    date: session.date,
                    volume: this.calculateSessionVolume(session.sets, session.weight)
                })).reverse();
            }
        }

        class Timer {
            constructor() {
                this.interval = null;
                this.timeRemaining = 0;
                this.totalTime = 0;
                this.onTick = null;
                this.onComplete = null;
                this.audioEnabled = true;
            }

            start(seconds, onTick, onComplete) {
                this.stop();
                this.totalTime = seconds;
                this.timeRemaining = seconds;
                this.onTick = onTick;
                this.onComplete = onComplete;

                this.interval = setInterval(() => {
                    this.timeRemaining--;

                    if (this.onTick) {
                        this.onTick(this.timeRemaining, this.totalTime);
                    }

                    if (this.audioEnabled) {
                        if (this.timeRemaining === 10) {
                            this.playBeep();
                        }
                        if (this.timeRemaining === 0) {
                            this.playDoubleBeep();
                        }
                    }

                    if (this.timeRemaining <= 0) {
                        this.stop();
                        if (this.onComplete) {
                            this.onComplete();
                        }
                    }
                }, 1000);
            }

            stop() {
                if (this.interval) {
                    clearInterval(this.interval);
                    this.interval = null;
                }
            }

            skip() {
                this.stop();
                if (this.onComplete) {
                    this.onComplete();
                }
            }

            extend(seconds) {
                this.timeRemaining += seconds;
                this.totalTime += seconds;
                if (this.onTick) {
                    this.onTick(this.timeRemaining, this.totalTime);
                }
            }

            playBeep() {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 800;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);
            }

            playDoubleBeep() {
                this.playBeep();
                setTimeout(() => this.playBeep(), 150);
            }

            formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }
        }

        const WORKOUT_TEMPLATES = [
            {
                name: 'Full Body Strength A',
                description: 'Complete full-body workout hitting all major movement patterns',
                exercises: [
                    { exerciseName: 'Bulgarian Split Squat', sets: 3, repRange: [8, 12], restTime: 90 },
                    { exerciseName: 'Dumbbell Floor Press', sets: 3, repRange: [8, 12], restTime: 90 },
                    { exerciseName: 'Kettlebell Row (2-Arm)', sets: 3, repRange: [10, 15], restTime: 75 },
                    { exerciseName: 'Dumbbell Shoulder Press', sets: 3, repRange: [8, 12], restTime: 75 },
                    { exerciseName: 'Dumbbell Glute Bridge', sets: 3, repRange: [12, 20], restTime: 60 },
                    { exerciseName: 'Plank', sets: 3, repRange: [30, 60], restTime: 60 }
                ]
            },
            {
                name: 'Full Body Strength B',
                description: 'Alternative full-body workout with different exercise variations',
                exercises: [
                    { exerciseName: 'Dumbbell Walking Lunge', sets: 3, repRange: [10, 14], restTime: 90 },
                    { exerciseName: 'Push-Up', sets: 3, repRange: [12, 20], restTime: 75 },
                    { exerciseName: 'Heavy Kettlebell Row', sets: 3, repRange: [8, 12], restTime: 90 },
                    { exerciseName: 'Dumbbell Single-Leg RDL', sets: 3, repRange: [8, 12], restTime: 75 },
                    { exerciseName: 'Dead Bug', sets: 3, repRange: [12, 20], restTime: 60 },
                    { exerciseName: 'Kettlebell Swing', sets: 3, repRange: [15, 20], restTime: 75 }
                ]
            },
            {
                name: 'Upper Body Focus',
                description: '2-day upper body template focusing on push and pull',
                exercises: [
                    { exerciseName: 'Dumbbell Floor Press', sets: 4, repRange: [8, 12], restTime: 120 },
                    { exerciseName: 'Kettlebell Row (2-Arm)', sets: 4, repRange: [10, 15], restTime: 90 },
                    { exerciseName: 'Dumbbell Shoulder Press', sets: 3, repRange: [8, 12], restTime: 90 },
                    { exerciseName: 'Diamond Push-Up', sets: 3, repRange: [8, 15], restTime: 75 },
                    { exerciseName: 'Pallof Press', sets: 3, repRange: [12, 15], restTime: 60 }
                ]
            },
            {
                name: 'Lower Body Focus',
                description: 'Lower body strength and power development',
                exercises: [
                    { exerciseName: 'Bulgarian Split Squat', sets: 4, repRange: [8, 12], restTime: 120 },
                    { exerciseName: 'Dumbbell Single-Leg RDL', sets: 3, repRange: [8, 12], restTime: 90 },
                    { exerciseName: 'Jump Squat', sets: 3, repRange: [10, 15], restTime: 90 },
                    { exerciseName: 'Dumbbell Glute Bridge', sets: 3, repRange: [15, 20], restTime: 75 },
                    { exerciseName: 'Farmers Carry', sets: 3, repRange: [40, 60], restTime: 90 }
                ]
            }
        ];

        class App {
            constructor() {
                this.db = new Database();
                this.timer = new Timer();
                this.progressionEngine = null;
                this.currentPage = 'home';
                this.activeWorkout = null;
                this.currentExerciseIndex = 0;
                this.currentSet = 0;
                this.sessionData = [];
                this.sessionStartTime = null;
                this.exerciseCache = [];
                this.pendingConfirmAction = null;
                this.pendingConfirmContext = null;
                this.defaultRestTime = 90;
                this.workoutBuilder = null;
                this.builderWorkoutId = null;
                this.exercisePickerData = [];
            }

            async init() {
                try {
                    await this.db.init();
                    this.progressionEngine = new ProgressionEngine(this.db);

                    await this.initializeExerciseDatabase();
                    await this.initializeSettings();

                    this.initializePWA();

                    this.navigate('home');
                } catch (error) {
                    console.error('App initialization failed:', error);
                    this.showCustomAlert('Initialization failed. Please reload the app.');
                }
            }

            async initializeExerciseDatabase() {
                let exercises = await this.db.getAll('exercises');
                if (exercises.length === 0) {
                    for (const exercise of EXERCISE_DATABASE) {
                        await this.db.add('exercises', exercise);
                    }
                    exercises = await this.db.getAll('exercises');
                    console.log('Exercise database initialized with', exercises.length, 'exercises');
                }
                this.exerciseCache = exercises;
            }

            async initializeSettings() {
                let settings = await this.db.get('settings', 'general');
                if (!settings) {
                    settings = {
                        key: 'general',
                        defaultRestTime: 90,
                        audioEnabled: true,
                        theme: 'dark'
                    };
                    await this.db.put('settings', settings);
                }

                this.defaultRestTime = Number.isFinite(settings.defaultRestTime) && settings.defaultRestTime > 0 ? settings.defaultRestTime : 90;
                this.timer.audioEnabled = settings.audioEnabled !== false;
                this.applyTheme(settings.theme || 'dark');
            }

            initializePWA() {
                const manifest = {
                    name: 'Strength Training Companion',
                    short_name: 'Strength',
                    description: 'Progressive strength training tracker',
                    start_url: '.',
                    display: 'standalone',
                    background_color: '#0F1419',
                    theme_color: '#0F1419',
                    orientation: 'portrait-primary',
                    icons: [
                        {
                            src: this.generateIcon(),
                            sizes: '192x192',
                            type: 'image/png',
                            purpose: 'any maskable'
                        },
                        {
                            src: this.generateIcon(512),
                            sizes: '512x512',
                            type: 'image/png',
                            purpose: 'any maskable'
                        }
                    ]
                };

                const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
                const manifestURL = URL.createObjectURL(manifestBlob);
                document.getElementById('manifest-placeholder').setAttribute('href', manifestURL);

                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register(this.generateServiceWorker())
                        .then(() => console.log('Service Worker registered'))
                        .catch(err => console.error('Service Worker registration failed:', err));
                }
            }

            generateIcon(size = 192) {
                const canvas = document.createElement('canvas');
                canvas.width = size;
                canvas.height = size;
                const ctx = canvas.getContext('2d');

                ctx.fillStyle = '#2D5A7B';
                ctx.fillRect(0, 0, size, size);

                ctx.fillStyle = '#E8E8E8';
                ctx.font = `bold ${size * 0.5}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('ðŸ’ª', size / 2, size / 2);

                return canvas.toDataURL();
            }

            generateServiceWorker() {
                const swCode = `
                    self.addEventListener('install', (event) => {
                        self.skipWaiting();
                    });

                    self.addEventListener('activate', (event) => {
                        event.waitUntil(clients.claim());
                    });

                    self.addEventListener('fetch', (event) => {
                        event.respondWith(fetch(event.request));
                    });
                `;

                const blob = new Blob([swCode], { type: 'application/javascript' });
                return URL.createObjectURL(blob);
            }

            async navigate(page, data = null) {
                if (page !== 'workout-session') {
                    this.timer.stop();
                }

                this.currentPage = page;

                document.querySelectorAll('.nav-item').forEach(item => {
                    if (item.dataset.page === page) {
                        item.classList.add('text-accent');
                    } else {
                        item.classList.remove('text-accent');
                    }
                });

                await this.renderPage(page, data);
            }

            async renderPage(page, data) {
                const appContainer = document.getElementById('app');

                switch(page) {
                    case 'home':
                        appContainer.innerHTML = await this.renderHomePage();
                        break;
                    case 'workouts':
                        appContainer.innerHTML = await this.renderWorkoutsPage();
                        break;
                    case 'exercises':
                        appContainer.innerHTML = await this.renderExercisesPage();
                        break;
                    case 'progress':
                        appContainer.innerHTML = await this.renderProgressPage();
                        break;
                    case 'settings':
                        appContainer.innerHTML = await this.renderSettingsPage();
                        break;
                    case 'workout-session':
                        appContainer.innerHTML = await this.renderWorkoutSession(data);
                        document.getElementById('bottom-nav').style.display = this.activeWorkout ? 'none' : 'block';
                        break;
                    case 'exercise-detail':
                        appContainer.innerHTML = await this.renderExerciseDetail(data);
                        break;
                    case 'workout-builder':
                        appContainer.innerHTML = await this.renderWorkoutBuilder(data);
                        break;
                    default:
                        appContainer.innerHTML = '<div class="p-4">Page not found</div>';
                }

                if (page !== 'workout-session') {
                    document.getElementById('bottom-nav').style.display = 'block';
                } else if (!this.activeWorkout) {
                    document.getElementById('bottom-nav').style.display = 'block';
                }

                window.scrollTo(0, 0);
            }

            async renderHomePage() {
                const workouts = await this.db.getAll('workouts');
                const recentHistory = (await this.db.getAll('history')).sort((a, b) =>
                    new Date(b.date) - new Date(a.date)
                ).slice(0, 5);

                return `
                    <div class="min-h-screen pb-8">
                        <div class="bg-gradient-to-br from-accent to-accent-hover p-8 pb-12">
                            <h1 class="text-3xl font-bold mb-2">Strength Training</h1>
                            <p class="text-text-secondary text-sm">Your progressive workout companion</p>
                        </div>

                        <div class="px-4 -mt-6">
                            <div class="gradient-border">
                                <div class="gradient-border-inner p-6">
                                    <h2 class="text-xl font-semibold mb-4">Quick Start</h2>
                                    ${workouts.length > 0 ? `
                                        <div class="space-y-3">
                                            ${workouts.slice(0, 3).map(workout => {
                                                const name = this.escapeHTML(workout.name || 'Workout');
                                                const exerciseCount = Array.isArray(workout.exercises) ? workout.exercises.length : 0;
                                                return `
                                                    <button onclick="app.startWorkout(${workout.id})"
                                                        class="w-full bg-accent hover:bg-accent-hover text-left p-4 rounded-lg transition-colors touch-target">
                                                        <div class="flex items-center justify-between">
                                                            <div>
                                                                <div class="font-semibold">${name}</div>
                                                                <div class="text-sm text-text-secondary">${exerciseCount} exercises</div>
                                                            </div>
                                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                                            </svg>
                                                        </div>
                                                    </button>
                                                `;
                                            }).join('')}
                                        </div>
                                    ` : `
                                        <p class="text-text-secondary mb-4">No workouts yet. Create your first workout to get started!</p>
                                        <button onclick="app.navigate('workouts')"
                                            class="w-full bg-accent hover:bg-accent-hover p-4 rounded-lg transition-colors touch-target">
                                            Create Workout
                                        </button>
                                    `}
                                </div>
                            </div>
                        </div>

                        ${recentHistory.length > 0 ? `
                            <div class="px-4 mt-8">
                                <h2 class="text-xl font-semibold mb-4">Recent Sessions</h2>
                                <div class="space-y-3">
                                    ${recentHistory.map(session => {
                                        const workoutName = this.escapeHTML(session.workoutName || 'Workout');
                                        const exerciseCount = Array.isArray(session.exercises) ? session.exercises.length : 0;
                                        const sessionDate = session.date ? new Date(session.date).toLocaleDateString() : '';
                                        return `
                                            <div class="bg-secondary-bg p-4 rounded-lg">
                                                <div class="flex items-center justify-between">
                                                    <div>
                                                        <div class="font-semibold">${workoutName}</div>
                                                        <div class="text-sm text-text-secondary">
                                                            ${sessionDate} â€¢ ${exerciseCount} exercises
                                                        </div>
                                                    </div>
                                                    <div class="text-success font-semibold">âœ“</div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <div class="px-4 mt-8">
                            <h2 class="text-xl font-semibold mb-4">This Week</h2>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-secondary-bg p-4 rounded-lg">
                                    <div class="text-2xl font-bold text-accent">${this.getWeeklyWorkouts(recentHistory)}</div>
                                    <div class="text-sm text-text-secondary">Workouts</div>
                                </div>
                                <div class="bg-secondary-bg p-4 rounded-lg">
                                    <div class="text-2xl font-bold text-success">${workouts.length}</div>
                                    <div class="text-sm text-text-secondary">Total Programs</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            getWeeklyWorkouts(history) {
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                return history.filter(session => new Date(session.date) >= oneWeekAgo).length;
            }

            async renderWorkoutsPage() {
                const workouts = await this.db.getAll('workouts');

                return `
                    <div class="min-h-screen pb-8">
                        <div class="bg-secondary-bg p-6 sticky top-0 z-10 border-b border-gray-800">
                            <div class="flex items-center justify-between">
                                <h1 class="text-2xl font-bold">My Workouts</h1>
                                <button onclick="app.showTemplateModal()"
                                    class="bg-accent hover:bg-accent-hover px-4 py-2 rounded-lg transition-colors touch-target">
                                    + New
                                </button>
                            </div>
                        </div>

                        <div class="px-4 mt-6">
                            ${workouts.length > 0 ? `
                                <div class="space-y-4">
                                    ${workouts.map(workout => {
                                        const name = this.escapeHTML(workout.name || 'Untitled Workout');
                                        const description = this.escapeHTML(workout.description || '');
                                        const exerciseCount = Array.isArray(workout.exercises) ? workout.exercises.length : 0;
                                        const duration = this.estimateWorkoutDuration(workout);
                                        return `
                                            <div class="bg-secondary-bg rounded-lg overflow-hidden">
                                                <div class="p-4">
                                                    <div class="flex items-start justify-between mb-2">
                                                        <div class="flex-1">
                                                            <h3 class="text-lg font-semibold">${name}</h3>
                                                            ${description ? `<p class="text-sm text-text-secondary mt-1">${description}</p>` : ''}
                                                        </div>
                                                        <button onclick="app.deleteWorkout(${workout.id})"
                                                            class="ml-2 text-text-secondary hover:text-warning">
                                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                            </svg>
                                                        </button>
                                                    </div>

                                                    <div class="flex items-center gap-4 text-sm text-text-secondary mt-3">
                                                        <span>${exerciseCount} exercises</span>
                                                        <span>â€¢</span>
                                                        <span>~${duration} min</span>
                                                    </div>

                                                    <div class="flex gap-2 mt-4">
                                                        <button onclick="app.startWorkout(${workout.id})"
                                                            class="flex-1 bg-accent hover:bg-accent-hover py-3 rounded-lg transition-colors touch-target font-semibold">
                                                            Start Workout
                                                        </button>
                                                        <button onclick="app.editWorkout(${workout.id})"
                                                            class="px-4 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors touch-target">
                                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                            </svg>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : `
                                <div class="text-center py-12">
                                    <svg class="w-20 h-20 mx-auto text-text-secondary mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                    </svg>
                                    <h3 class="text-xl font-semibold mb-2">No Workouts Yet</h3>
                                    <p class="text-text-secondary mb-6">Create your first workout or use a template</p>
                                    <button onclick="app.showTemplateModal()"
                                        class="bg-accent hover:bg-accent-hover px-6 py-3 rounded-lg transition-colors touch-target">
                                        Browse Templates
                                    </button>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }

            estimateWorkoutDuration(workout) {
                if (!Array.isArray(workout.exercises) || workout.exercises.length === 0) return 0;
                const totalSets = workout.exercises.reduce((sum, ex) => sum + (Number(ex.sets) > 0 ? Number(ex.sets) : 3), 0);
                const workTime = totalSets * 0.75;
                const restTime = workout.exercises.reduce((sum, ex) => {
                    const rest = Number(ex.restTime);
                    return sum + ((Number.isFinite(rest) && rest >= 0 ? rest : this.defaultRestTime) / 60);
                }, 0);
                return Math.round(workTime + restTime);
            }

            async renderExercisesPage() {
                const exercises = await this.getExercises();
                const categories = [...new Set(exercises.map(ex => ex.category))];

                return `
                    <div class="min-h-screen pb-8">
                        <div class="bg-secondary-bg p-6 sticky top-0 z-10 border-b border-gray-800">
                            <h1 class="text-2xl font-bold mb-4">Exercise Library</h1>

                            <input type="text" id="exercise-search" placeholder="Search exercises..."
                                oninput="app.filterExercises(this.value)"
                                class="w-full bg-primary-bg text-text-primary px-4 py-3 rounded-lg border border-gray-700 focus:border-accent outline-none text-base">
                        </div>

                        <div class="px-4 py-4 overflow-x-auto hide-scrollbar">
                            <div class="flex gap-2 min-w-max">
                                <button onclick="app.filterByCategory('all')"
                                    class="category-filter active px-4 py-2 rounded-full bg-accent text-sm whitespace-nowrap" data-category="all">
                                    All
                                </button>
                                ${categories.map(cat => `
                                    <button onclick="app.filterByCategory('${cat}')"
                                        class="category-filter px-4 py-2 rounded-full bg-gray-700 hover:bg-gray-600 text-sm whitespace-nowrap" data-category="${cat}">
                                        ${this.escapeHTML(cat)}
                                    </button>
                                `).join('')}
                            </div>
                        </div>

                        <div id="exercise-list" class="px-4">
                            ${this.renderExerciseList(exercises)}
                        </div>
                    </div>
                `;
            }

            renderExerciseList(exercises) {
                if (!exercises.length) {
                    return `
                        <div class="text-center py-12">
                            <p class="text-text-secondary">No exercises found</p>
                        </div>
                    `;
                }

                return `
                    <div class="space-y-3">
                        ${exercises.map(exercise => `
                            <button onclick="app.viewExerciseDetail(${exercise.id})"
                                class="w-full bg-secondary-bg p-4 rounded-lg text-left hover:bg-opacity-80 transition-colors touch-target"
                                data-exercise-category="${this.escapeHTML(exercise.category)}">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <h3 class="font-semibold">${this.escapeHTML(exercise.name)}</h3>
                                        <div class="flex items-center gap-2 mt-1">
                                            <span class="text-xs px-2 py-1 bg-accent bg-opacity-20 text-accent rounded">${this.escapeHTML(exercise.category)}</span>
                                            <span class="text-xs px-2 py-1 bg-gray-700 rounded">${this.escapeHTML(exercise.difficulty)}</span>
                                        </div>
                                        <div class="text-sm text-text-secondary mt-2">
                                            ${this.formatEquipment(exercise.equipment)}
                                        </div>
                                    </div>
                                    <svg class="w-5 h-5 text-text-secondary ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                    </svg>
                                </div>
                            </button>
                        `).join('')}
                    </div>
                `;
            }

            formatEquipment(equipment) {
                if (!equipment) return 'â€”';
                const map = {
                    bodyweight: 'Bodyweight',
                    dumbbell_25: 'DB 25 lbs',
                    dumbbell_35: 'DB 35 lbs',
                    kettlebell_50: 'KB 50 lbs',
                    kettlebell_70: 'KB 70 lbs'
                };
                const list = Array.isArray(equipment) ? equipment : [equipment];
                if (!list.length) return 'â€”';
                return list.map(eq => map[eq] || this.escapeHTML(eq)).join(', ');
            }

            async renderExerciseDetail(exerciseId) {
                const exercises = await this.getExercises();
                const id = typeof exerciseId === 'string' ? parseInt(exerciseId, 10) : exerciseId;
                const exercise = exercises.find(ex => ex.id === id);

                if (!exercise) {
                    return `
                        <div class="p-6">
                            <button onclick="app.navigate('exercises')" class="mb-4 text-text-secondary hover:text-text-primary">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                            </button>
                            <p class="text-text-secondary">Exercise not found.</p>
                        </div>
                    `;
                }

                const history = await this.db.getByIndex('exerciseHistory', 'exerciseId', exercise.id);
                const recentHistory = history.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);

                return `
                    <div class="min-h-screen pb-8">
                        <div class="bg-secondary-bg p-6 sticky top-0 z-10 border-b border-gray-800">
                            <button onclick="app.navigate('exercises')" class="mb-4 text-text-secondary hover:text-text-primary">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                            </button>
                            <h1 class="text-2xl font-bold">${this.escapeHTML(exercise.name)}</h1>
                            <div class="flex gap-2 mt-3">
                                <span class="text-xs px-3 py-1 bg-accent bg-opacity-20 text-accent rounded-full">${this.escapeHTML(exercise.category)}</span>
                                <span class="text-xs px-3 py-1 bg-gray-700 rounded-full">${this.escapeHTML(exercise.difficulty)}</span>
                                <span class="text-xs px-3 py-1 bg-gray-700 rounded-full">${this.escapeHTML(exercise.movementType)}</span>
                            </div>
                        </div>

                        <div class="px-4 mt-6">
                            <h2 class="text-lg font-semibold mb-3">Equipment Needed</h2>
                            <div class="bg-secondary-bg p-4 rounded-lg">
                                <p class="text-text-secondary">${this.formatEquipment(exercise.equipment)}</p>
                            </div>
                        </div>

                        <div class="px-4 mt-6">
                            <h2 class="text-lg font-semibold mb-3">Form & Technique</h2>
                            <div class="bg-secondary-bg p-4 rounded-lg space-y-3">
                                ${exercise.formCues.map((cue, idx) => `
                                    <div class="flex gap-3">
                                        <div class="flex-shrink-0 w-6 h-6 bg-accent rounded-full flex items-center justify-center text-sm font-semibold">
                                            ${idx + 1}
                                        </div>
                                        <p class="text-text-secondary flex-1">${this.escapeHTML(cue)}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="px-4 mt-6">
                            <h2 class="text-lg font-semibold mb-3">Recommended Rep Range</h2>
                            <div class="bg-secondary-bg p-4 rounded-lg">
                                <p class="text-2xl font-bold text-accent">${exercise.repRange[0]} - ${exercise.repRange[1]} reps</p>
                            </div>
                        </div>

                        ${exercise.progressionPath ? `
                            <div class="px-4 mt-6">
                                <h2 class="text-lg font-semibold mb-3">Next Progression</h2>
                                <div class="bg-secondary-bg p-4 rounded-lg">
                                    <p class="text-success">â†’ ${this.escapeHTML(exercise.progressionPath)}</p>
                                </div>
                            </div>
                        ` : ''}

                        ${recentHistory.length > 0 ? `
                            <div class="px-4 mt-6">
                                <h2 class="text-lg font-semibold mb-3">Recent Sessions</h2>
                                <div class="space-y-3">
                                    ${recentHistory.map(session => {
                                        const sessionDate = session.date ? new Date(session.date).toLocaleDateString() : '';
                                        const weightLabel = session.weight ? this.formatEquipment(session.weight) : 'â€”';
                                        const setsSummary = Array.isArray(session.sets)
                                            ? session.sets.map(set => `${set.reps || 0} reps`).join(' â€¢ ')
                                            : 'No data';
                                        return `
                                            <div class="bg-secondary-bg p-4 rounded-lg">
                                                <div class="flex items-center justify-between mb-2">
                                                    <span class="text-sm text-text-secondary">${sessionDate}</span>
                                                    <span class="text-sm font-semibold">${weightLabel}</span>
                                                </div>
                                                <div class="text-sm text-text-secondary">
                                                    ${setsSummary}
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            async renderProgressPage() {
                const history = await this.db.getAll('history');
                const exerciseHistory = await this.db.getAll('exerciseHistory');

                const totalWorkouts = history.length;
                const thisMonth = history.filter(h => {
                    const date = new Date(h.date);
                    const now = new Date();
                    return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
                }).length;

                const exerciseFrequency = {};
                exerciseHistory.forEach(eh => {
                    exerciseFrequency[eh.exerciseId] = (exerciseFrequency[eh.exerciseId] || 0) + 1;
                });

                return `
                    <div class="min-h-screen pb-8">
                        <div class="bg-secondary-bg p-6">
                            <h1 class="text-2xl font-bold">Progress Tracking</h1>
                        </div>

                        <div class="px-4 mt-6">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-secondary-bg p-4 rounded-lg">
                                    <div class="text-3xl font-bold text-accent mb-1">${totalWorkouts}</div>
                                    <div class="text-sm text-text-secondary">Total Workouts</div>
                                </div>
                                <div class="bg-secondary-bg p-4 rounded-lg">
                                    <div class="text-3xl font-bold text-success mb-1">${thisMonth}</div>
                                    <div class="text-sm text-text-secondary">This Month</div>
                                </div>
                                <div class="bg-secondary-bg p-4 rounded-lg">
                                    <div class="text-3xl font-bold text-warning mb-1">${Object.keys(exerciseFrequency).length}</div>
                                    <div class="text-sm text-text-secondary">Exercises Logged</div>
                                </div>
                                <div class="bg-secondary-bg p-4 rounded-lg">
                                    <div class="text-3xl font-bold text-accent mb-1">${this.calculateStreak(history)}</div>
                                    <div class="text-sm text-text-secondary">Day Streak</div>
                                </div>
                            </div>
                        </div>

                        <div class="px-4 mt-8">
                            <h2 class="text-xl font-semibold mb-4">Workout History</h2>
                            ${history.length > 0 ? `
                                <div class="space-y-3">
                                    ${history.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10).map(session => {
                                        const name = this.escapeHTML(session.workoutName || 'Workout');
                                        const sessionDate = session.date ? new Date(session.date).toLocaleDateString() : '';
                                        const exerciseCount = Array.isArray(session.exercises) ? session.exercises.length : 0;
                                        const duration = session.duration ? `${Math.round(session.duration / 60)} min` : '';
                                        return `
                                            <div class="bg-secondary-bg p-4 rounded-lg">
                                                <div class="flex items-center justify-between mb-2">
                                                    <h3 class="font-semibold">${name}</h3>
                                                    <span class="text-success">âœ“</span>
                                                </div>
                                                <div class="text-sm text-text-secondary">
                                                    ${sessionDate} â€¢ ${exerciseCount} exercises ${duration ? `â€¢ ${duration}` : ''}
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : `
                                <div class="text-center py-12">
                                    <svg class="w-20 h-20 mx-auto text-text-secondary mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <h3 class="text-xl font-semibold mb-2">No Workouts Yet</h3>
                                    <p class="text-text-secondary">Complete your first workout to start tracking progress!</p>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }

            calculateStreak(history) {
                if (history.length === 0) return 0;

                const sortedDates = history
                    .map(h => new Date(h.date).toDateString())
                    .sort((a, b) => new Date(b) - new Date(a));

                const uniqueDates = [...new Set(sortedDates)];
                let streak = 0;

                for (let i = 0; i < uniqueDates.length; i++) {
                    const checkDate = new Date();
                    checkDate.setDate(checkDate.getDate() - i);

                    if (uniqueDates.includes(checkDate.toDateString())) {
                        streak++;
                    } else {
                        break;
                    }
                }

                return streak;
            }

            async renderSettingsPage() {
                const settings = await this.db.get('settings', 'general') || {
                    defaultRestTime: this.defaultRestTime,
                    audioEnabled: this.timer.audioEnabled,
                    theme: 'dark'
                };

                return `
                    <div class="min-h-screen pb-8">
                        <div class="bg-secondary-bg p-6">
                            <h1 class="text-2xl font-bold">Settings</h1>
                        </div>

                        <div class="px-4 mt-6 space-y-6">
                            <div>
                                <h2 class="text-lg font-semibold mb-4">Timer Settings</h2>
                                <div class="bg-secondary-bg rounded-lg overflow-hidden">
                                    <div class="p-4 border-b border-gray-800">
                                        <label class="block text-sm text-text-secondary mb-2">Default Rest Time (seconds)</label>
                                        <input type="number" id="default-rest-time" value="${settings.defaultRestTime}"
                                            onchange="app.updateSetting('defaultRestTime', parseInt(this.value, 10))"
                                            min="1"
                                            class="w-full bg-primary-bg text-text-primary px-4 py-3 rounded-lg border border-gray-700 focus:border-accent outline-none text-base">
                                    </div>

                                    <div class="p-4">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <div class="font-semibold">Audio Cues</div>
                                                <div class="text-sm text-text-secondary">Beeps at 10s and completion</div>
                                            </div>
                                            <label class="relative inline-block w-14 h-8">
                                                <input type="checkbox" ${settings.audioEnabled ? 'checked' : ''}
                                                    onchange="app.updateSetting('audioEnabled', this.checked)"
                                                    class="opacity-0 w-0 h-0 peer">
                                                <span class="absolute cursor-pointer inset-0 bg-gray-700 rounded-full transition-all peer-checked:bg-accent">
                                                    <span class="absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition-all peer-checked:translate-x-6"></span>
                                                </span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <h2 class="text-lg font-semibold mb-4">Data Management</h2>
                                <div class="bg-secondary-bg rounded-lg overflow-hidden">
                                    <button onclick="app.exportData()"
                                        class="w-full p-4 text-left hover:bg-opacity-80 border-b border-gray-800 touch-target">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <div class="font-semibold">Export Data</div>
                                                <div class="text-sm text-text-secondary">Download all workout data as JSON</div>
                                            </div>
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                            </svg>
                                        </div>
                                    </button>

                                    <button onclick="app.confirmClearData()"
                                        class="w-full p-4 text-left hover:bg-opacity-80 text-warning touch-target">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <div class="font-semibold">Clear All Data</div>
                                                <div class="text-sm text-text-secondary">Reset app to default state</div>
                                            </div>
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                        </div>
                                    </button>
                                </div>
                            </div>

                            <div>
                                <h2 class="text-lg font-semibold mb-4">About</h2>
                                <div class="bg-secondary-bg rounded-lg p-4">
                                    <div class="text-center">
                                        <div class="text-4xl mb-2">ðŸ’ª</div>
                                        <div class="font-semibold mb-1">Strength Training Companion</div>
                                        <div class="text-sm text-text-secondary">Version 1.0.0</div>
                                        <div class="text-xs text-text-secondary mt-4">
                                            Progressive Web App for evidence-based strength training
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            async renderWorkoutSession(workoutData) {
                let workout = null;
                if (workoutData && typeof workoutData === 'object') {
                    workout = workoutData;
                } else {
                    const workoutId = typeof workoutData === 'string' ? parseInt(workoutData, 10) : workoutData;
                    workout = await this.db.get('workouts', workoutId);
                }

                if (!workout) {
                    this.activeWorkout = null;
                    return `
                        <div class="p-6 space-y-4">
                            <p class="text-text-secondary">Workout not found.</p>
                            <button onclick="app.navigate('workouts')"
                                class="bg-accent hover:bg-accent-hover px-4 py-2 rounded-lg touch-target">
                                Back to Workouts
                            </button>
                        </div>
                    `;
                }

                const exercisesList = Array.isArray(workout.exercises) ? workout.exercises : [];
                if (exercisesList.length === 0) {
                    this.activeWorkout = null;
                    return `
                        <div class="p-6 space-y-4">
                            <p class="text-text-secondary">This workout has no exercises. Please add exercises before starting.</p>
                            <button onclick="app.navigate('workouts')"
                                class="bg-accent hover:bg-accent-hover px-4 py-2 rounded-lg touch-target">
                                Edit Workouts
                            </button>
                        </div>
                    `;
                }

                const exerciseLibrary = await this.getExercises();
                const sanitizedWorkout = {
                    id: workout.id,
                    name: workout.name || 'Workout',
                    description: workout.description || '',
                    exercises: exercisesList.map(ex => {
                        const exerciseName = ex.exerciseName || '';
                        const sets = Math.max(1, parseInt(ex.sets, 10) || 1);
                        const minRep = Math.max(1, parseInt(ex.repRange?.[0], 10) || 1);
                        const maxRepCandidate = Math.max(minRep, parseInt(ex.repRange?.[1], 10) || minRep);
                        const repRange = [minRep, maxRepCandidate];
                        const restParsed = parseInt(ex.restTime, 10);
                        const restTime = Number.isFinite(restParsed) && restParsed >= 0 ? restParsed : this.defaultRestTime;
                        return {
                            exerciseName,
                            sets,
                            repRange,
                            restTime
                        };
                    })
                };

                this.activeWorkout = sanitizedWorkout;
                this.currentExerciseIndex = 0;
                this.currentSet = 0;
                this.sessionData = [];
                this.sessionStartTime = Date.now();

                for (const exercise of sanitizedWorkout.exercises) {
                    const details = exerciseLibrary.find(ex => ex.name === exercise.exerciseName) || null;
                    this.sessionData.push({
                        exerciseName: exercise.exerciseName,
                        exerciseId: details?.id ?? null,
                        targetSets: exercise.sets,
                        targetRepRange: exercise.repRange,
                        restTime: exercise.restTime,
                        completedSets: [],
                        exerciseDetails: details
                    });
                }

                return await this.renderCurrentExercise();
            }

            async renderCurrentExercise() {
                if (!this.activeWorkout) {
                    return `
                        <div class="p-6 space-y-4">
                            <p class="text-text-secondary">No active workout.</p>
                            <button onclick="app.navigate('workouts')"
                                class="bg-accent hover:bg-accent-hover px-4 py-2 rounded-lg touch-target">
                                Back to Workouts
                            </button>
                        </div>
                    `;
                }

                const workoutExercises = this.activeWorkout.exercises || [];
                if (!workoutExercises.length) {
                    return `
                        <div class="p-6 space-y-4">
                            <p class="text-text-secondary">This workout has no exercises to display.</p>
                            <button onclick="app.navigate('workouts')"
                                class="bg-accent hover:bg-accent-hover px-4 py-2 rounded-lg touch-target">
                                Back to Workouts
                            </button>
                        </div>
                    `;
                }

                const currentExercise = workoutExercises[this.currentExerciseIndex];
                const sessionExercise = this.sessionData[this.currentExerciseIndex];
                const isLastExercise = this.currentExerciseIndex === workoutExercises.length - 1;
                const isLastSet = sessionExercise.completedSets.length >= sessionExercise.targetSets - 1;

                let lastSessionMarkup = '';
                if (sessionExercise.exerciseId) {
                    const historyEntries = await this.db.getByIndex('exerciseHistory', 'exerciseId', sessionExercise.exerciseId);
                    if (historyEntries.length) {
                        const lastSession = historyEntries.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                        const sessionDate = lastSession.date ? new Date(lastSession.date).toLocaleDateString() : '';
                        const setsSummary = Array.isArray(lastSession.sets)
                            ? lastSession.sets.map(set => `${set.reps || 0} reps`).join(' â€¢ ')
                            : 'No sets logged';
                        const weightLabel = lastSession.weight ? this.formatEquipment(lastSession.weight) : 'â€”';
                        lastSessionMarkup = `
                            <div class="text-sm text-text-secondary text-center mb-4">
                                Last time (${sessionDate}): ${setsSummary} @ ${weightLabel}
                            </div>
                        `;
                    }
                }

                const formCues = sessionExercise.exerciseDetails?.formCues?.slice(0, 2) || [];
                const formCuesMarkup = formCues.length ? `
                    <div id="form-cues" class="bg-secondary-bg rounded-lg p-4 mb-6">
                        <h3 class="font-semibold mb-3">Form Tips</h3>
                        <div class="space-y-2">
                            ${formCues.map(cue => `
                                <div class="flex gap-2 text-sm text-text-secondary">
                                    <span class="text-accent">â€¢</span>
                                    <span>${this.escapeHTML(cue)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : '';

                const completedSetsMarkup = sessionExercise.completedSets.length ? `
                    <div class="bg-secondary-bg rounded-lg p-4 mb-6">
                        <h3 class="font-semibold mb-3">Completed Sets</h3>
                        <div class="space-y-2">
                            ${sessionExercise.completedSets.map((set, idx) => `
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-text-secondary">Set ${idx + 1}</span>
                                    <span class="font-semibold text-success">${set.reps || 0} reps @ ${this.formatEquipment(set.weight || 'bodyweight')}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : '';

                const previousWeight = sessionExercise.completedSets.length
                    ? sessionExercise.completedSets[sessionExercise.completedSets.length - 1].weight
                    : 'bodyweight';

                const weightOptions = [
                    { value: 'bodyweight', label: 'Bodyweight' },
                    { value: 'dumbbell_25', label: 'Dumbbell 25 lbs' },
                    { value: 'dumbbell_35', label: 'Dumbbell 35 lbs' },
                    { value: 'kettlebell_50', label: 'Kettlebell 50 lbs' },
                    { value: 'kettlebell_70', label: 'Kettlebell 70 lbs' }
                ];

                const repsTarget = `${sessionExercise.targetRepRange[0]}-${sessionExercise.targetRepRange[1]} reps`;

                return `
                    <div class="min-h-screen bg-primary-bg pb-8">
                        <div class="bg-secondary-bg p-6 sticky top-0 z-10 border-b border-gray-800">
                            <div class="flex items-center justify-between mb-4">
                                <button onclick="app.confirmExitWorkout()" class="text-text-secondary hover:text-text-primary">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                                <div class="text-sm text-text-secondary">
                                    Exercise ${this.currentExerciseIndex + 1} of ${this.activeWorkout.exercises.length}
                                </div>
                            </div>
                            <h1 class="text-2xl font-bold">${this.escapeHTML(currentExercise.exerciseName)}</h1>
                            <div class="flex items-center gap-4 mt-2 text-text-secondary">
                                <span>Set ${sessionExercise.completedSets.length + 1} of ${sessionExercise.targetSets}</span>
                                <span>â€¢</span>
                                <span>Target: ${repsTarget}</span>
                            </div>
                        </div>

                        <div class="px-4 mt-6">
                            ${lastSessionMarkup}
                            ${formCuesMarkup}
                            ${completedSetsMarkup}

                            <div class="gradient-border mb-6">
                                <div class="gradient-border-inner p-6">
                                    <label class="block text-sm text-text-secondary mb-2">Reps Completed</label>
                                    <input type="number" id="reps-input"
                                        inputmode="numeric"
                                        min="1"
                                        placeholder="${sessionExercise.targetRepRange[0]}"
                                        class="w-full bg-primary-bg text-text-primary text-4xl font-bold text-center p-4 rounded-lg border-2 border-accent focus:border-accent outline-none mb-4">

                                    <label class="block text-sm text-text-secondary mb-2">Weight Used</label>
                                    <select id="weight-input"
                                        class="w-full bg-primary-bg text-text-primary px-4 py-3 rounded-lg border border-gray-700 focus:border-accent outline-none text-base mb-6">
                                        ${weightOptions.map(option => `
                                            <option value="${option.value}" ${option.value === previousWeight ? 'selected' : ''}>
                                                ${option.label}
                                            </option>
                                        `).join('')}
                                    </select>

                                    <button onclick="app.logSet()"
                                        class="w-full bg-accent hover:bg-accent-hover py-4 rounded-lg font-bold text-lg touch-target transition-colors">
                                        ${isLastSet && isLastExercise ? 'Complete Workout' : isLastSet ? 'Next Exercise' : 'Complete Set'}
                                    </button>
                                </div>
                            </div>

                            <div id="timer-container"></div>
                        </div>
                    </div>
                `;
            }

            async renderWorkoutBuilder(workoutId = null) {
                await this.getExercises();

                if (!this.workoutBuilder || this.builderWorkoutId !== workoutId) {
                    let workout = null;
                    if (workoutId !== null && workoutId !== undefined) {
                        workout = await this.db.get('workouts', workoutId);
                    }
                    this.workoutBuilder = {
                        name: workout?.name || '',
                        description: workout?.description || '',
                        exercises: Array.isArray(workout?.exercises)
                            ? workout.exercises.map(ex => {
                                const sets = Math.max(1, parseInt(ex.sets, 10) || 1);
                                const minRep = Math.max(1, parseInt(ex.repRange?.[0], 10) || 1);
                                const maxRepCandidate = Math.max(minRep, parseInt(ex.repRange?.[1], 10) || minRep);
                                const restParsed = parseInt(ex.restTime, 10);
                                const restTime = Number.isFinite(restParsed) && restParsed >= 0 ? restParsed : this.defaultRestTime;
                                return {
                                    exerciseName: ex.exerciseName || '',
                                    sets,
                                    repRange: [minRep, maxRepCandidate],
                                    restTime
                                };
                            })
                            : []
                    };
                    this.builderWorkoutId = workoutId ?? null;
                }

                const workout = this.workoutBuilder;

                return `
                    <div class="min-h-screen pb-8">
                        <div class="bg-secondary-bg p-6 sticky top-0 z-10 border-b border-gray-800">
                            <button onclick="app.navigate('workouts')" class="mb-4 text-text-secondary hover:text-text-primary">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                            </button>
                            <h1 class="text-2xl font-bold">${this.builderWorkoutId !== null ? 'Edit Workout' : 'Create Workout'}</h1>
                        </div>

                        <div class="px-4 mt-6">
                            <div class="mb-6">
                                <label class="block text-sm text-text-secondary mb-2">Workout Name</label>
                                <input type="text" id="workout-name" value="${this.escapeHTML(workout.name)}"
                                    placeholder="e.g., Full Body Strength A"
                                    oninput="app.updateBuilderField('name', this.value)"
                                    class="w-full bg-secondary-bg text-text-primary px-4 py-3 rounded-lg border border-gray-700 focus:border-accent outline-none text-base">
                            </div>

                            <div class="mb-6">
                                <label class="block text-sm text-text-secondary mb-2">Description (Optional)</label>
                                <textarea id="workout-description"
                                    placeholder="Brief description of this workout..."
                                    oninput="app.updateBuilderField('description', this.value)"
                                    class="w-full bg-secondary-bg text-text-primary px-4 py-3 rounded-lg border border-gray-700 focus:border-accent outline-none text-base resize-none"
                                    rows="3">${this.escapeHTML(workout.description)}</textarea>
                            </div>

                            <div class="mb-6">
                                <div class="flex items-center justify-between mb-3">
                                    <label class="text-sm text-text-secondary">Exercises</label>
                                    <button onclick="app.showExercisePicker()"
                                        class="text-accent hover:text-accent-hover text-sm font-semibold">
                                        + Add Exercise
                                    </button>
                                </div>

                                <div id="workout-exercises-list" class="space-y-3">
                                    ${workout.exercises.length
                                        ? workout.exercises.map((ex, idx) => this.renderWorkoutExerciseItem(ex, idx)).join('')
                                        : '<div class="text-center py-8 text-text-secondary">No exercises added yet</div>'}
                                </div>
                            </div>

                            <button onclick="app.saveWorkout()"
                                class="w-full bg-accent hover:bg-accent-hover py-4 rounded-lg font-bold text-lg touch-target transition-colors">
                                ${this.builderWorkoutId !== null ? 'Update Workout' : 'Create Workout'}
                            </button>
                        </div>
                    </div>
                `;
            }

            renderWorkoutExerciseItem(exercise, index) {
                const name = this.escapeHTML(exercise.exerciseName || 'Untitled Exercise');
                const sets = Number.isFinite(exercise.sets) && exercise.sets > 0 ? exercise.sets : 3;
                const repRange = Array.isArray(exercise.repRange) && exercise.repRange.length === 2
                    ? [
                        Math.max(1, parseInt(exercise.repRange[0], 10) || 1),
                        Math.max(1, parseInt(exercise.repRange[1], 10) || Math.max(1, parseInt(exercise.repRange[0], 10) || 1))
                    ]
                    : [8, 12];
                if (repRange[1] < repRange[0]) {
                    repRange[1] = repRange[0];
                }
                const restTime = Number.isFinite(exercise.restTime) && exercise.restTime >= 0 ? exercise.restTime : this.defaultRestTime;

                return `
                    <div class="bg-secondary-bg rounded-lg p-4" data-exercise-index="${index}">
                        <div class="flex items-start justify-between mb-3">
                            <h3 class="font-semibold flex-1">${name}</h3>
                            <button onclick="app.removeExerciseFromWorkout(${index})"
                                class="text-text-secondary hover:text-warning ml-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>

                        <div class="grid grid-cols-3 gap-2">
                            <div>
                                <label class="block text-xs text-text-secondary mb-1">Sets</label>
                                <input type="number" min="1" value="${sets}"
                                    onchange="app.updateExerciseSets(${index}, parseInt(this.value, 10))"
                                    class="w-full bg-primary-bg text-text-primary px-2 py-2 rounded text-sm border border-gray-700 focus:border-accent outline-none">
                            </div>
                            <div class="col-span-2">
                                <label class="block text-xs text-text-secondary mb-1">Rep Range</label>
                                <div class="flex gap-1 items-center">
                                    <input type="number" min="1" value="${repRange[0]}"
                                        onchange="app.updateExerciseRepRange(${index}, 'min', parseInt(this.value, 10))"
                                        class="w-full bg-primary-bg text-text-primary px-2 py-2 rounded text-sm border border-gray-700 focus:border-accent outline-none">
                                    <span class="text-text-secondary">-</span>
                                    <input type="number" min="1" value="${repRange[1]}"
                                        onchange="app.updateExerciseRepRange(${index}, 'max', parseInt(this.value, 10))"
                                        class="w-full bg-primary-bg text-text-primary px-2 py-2 rounded text-sm border border-gray-700 focus:border-accent outline-none">
                                </div>
                            </div>
                        </div>

                        <div class="mt-2">
                            <label class="block text-xs text-text-secondary mb-1">Rest Time (seconds)</label>
                            <input type="number" min="0" value="${restTime}"
                                onchange="app.updateExerciseRest(${index}, parseInt(this.value, 10))"
                                class="w-full bg-primary-bg text-text-primary px-2 py-2 rounded text-sm border border-gray-700 focus:border-accent outline-none">
                        </div>
                    </div>
                `;
            }

            async startWorkout(workoutId) {
                const workout = await this.db.get('workouts', workoutId);
                if (!workout) {
                    this.showCustomAlert('Workout not found.');
                    return;
                }

                if (!Array.isArray(workout.exercises) || workout.exercises.length === 0) {
                    this.showCustomAlert('This workout has no exercises. Please add exercises before starting.');
                    return;
                }

                this.navigate('workout-session', workout);
            }

            async logSet() {
                this.timer.stop();

                const repsInput = document.getElementById('reps-input');
                const weightSelect = document.getElementById('weight-input');

                if (!repsInput) {
                    this.showCustomAlert('Reps input not available. Please try again.');
                    return;
                }

                const reps = parseInt(repsInput.value, 10);
                if (!Number.isFinite(reps) || reps <= 0) {
                    this.showCustomAlert('Please enter a valid number of reps.');
                    return;
                }

                const weight = weightSelect ? weightSelect.value : 'bodyweight';
                const timerContainer = document.getElementById('timer-container');
                if (timerContainer) {
                    timerContainer.innerHTML = '';
                }

                const currentExercise = this.sessionData[this.currentExerciseIndex];
                currentExercise.completedSets.push({ reps, weight });

                if (currentExercise.completedSets.length >= currentExercise.targetSets) {
                    if (currentExercise.exerciseId) {
                        await this.db.add('exerciseHistory', {
                            exerciseId: currentExercise.exerciseId,
                            exerciseName: currentExercise.exerciseName,
                            sets: currentExercise.completedSets.map(set => ({ ...set })),
                            weight,
                            date: new Date().toISOString()
                        });
                    }

                    if (this.currentExerciseIndex >= this.activeWorkout.exercises.length - 1) {
                        await this.completeWorkout();
                        return;
                    }

                    this.currentExerciseIndex++;
                    this.currentSet = 0;
                    const appContainer = document.getElementById('app');
                    if (appContainer) {
                        appContainer.innerHTML = await this.renderCurrentExercise();
                    }
                } else {
                    repsInput.value = '';
                    repsInput.focus();
                    this.startRestTimer(currentExercise.restTime);
                }
            }

            startRestTimer(seconds) {
                const restSeconds = Number.isFinite(seconds) ? seconds : this.defaultRestTime;
                const timerContainer = document.getElementById('timer-container');

                if (!timerContainer) return;

                if (restSeconds <= 0) {
                    timerContainer.innerHTML = `
                        <div class="bg-secondary-bg rounded-lg p-4 text-center">
                            <div class="text-sm text-text-secondary">No rest scheduled. Ready for the next set!</div>
                        </div>
                    `;
                    return;
                }

                timerContainer.innerHTML = `
                    <div class="bg-secondary-bg rounded-lg p-6 text-center">
                        <div class="text-sm text-text-secondary mb-2">Rest Time</div>
                        <div id="timer-display" class="text-6xl font-bold text-accent mb-4">
                            ${this.timer.formatTime(restSeconds)}
                        </div>
                        <div class="flex gap-2">
                            <button onclick="app.timer.skip()"
                                class="flex-1 bg-gray-700 hover:bg-gray-600 py-3 rounded-lg touch-target">
                                Skip Rest
                            </button>
                            <button onclick="app.timer.extend(15)"
                                class="px-6 bg-gray-700 hover:bg-gray-600 py-3 rounded-lg touch-target">
                                +15s
                            </button>
                        </div>
                    </div>
                `;

                this.timer.start(
                    restSeconds,
                    (timeRemaining) => {
                        const display = document.getElementById('timer-display');
                        if (display) {
                            display.textContent = this.timer.formatTime(Math.max(0, timeRemaining));
                        }
                    },
                    () => {
                        const display = document.getElementById('timer-display');
                        if (display) {
                            display.textContent = '0:00';
                        }
                        timerContainer.innerHTML = `
                            <div class="bg-success bg-opacity-20 border border-success rounded-lg p-4 text-center">
                                <div class="text-success font-semibold mb-2">Rest Complete!</div>
                                <div class="text-sm text-text-secondary">Ready for next set</div>
                            </div>
                        `;
                        const repsInput = document.getElementById('reps-input');
                        if (repsInput) {
                            repsInput.focus();
                        }
                    }
                );
            }

            async completeWorkout() {
                this.timer.stop();

                const duration = (Date.now() - this.sessionStartTime) / 1000;

                const historyExercises = this.sessionData.map(exercise => ({
                    exerciseName: exercise.exerciseName,
                    exerciseId: exercise.exerciseId,
                    targetSets: exercise.targetSets,
                    targetRepRange: [...exercise.targetRepRange],
                    restTime: exercise.restTime,
                    completedSets: exercise.completedSets.map(set => ({ ...set }))
                }));

                await this.db.add('history', {
                    workoutId: this.activeWorkout.id,
                    workoutName: this.activeWorkout.name,
                    exercises: historyExercises,
                    date: new Date().toISOString(),
                    duration
                });

                this.activeWorkout = null;
                this.sessionData = [];
                this.currentExerciseIndex = 0;
                this.sessionStartTime = null;

                const appContainer = document.getElementById('app');
                if (appContainer) {
                    appContainer.innerHTML = `
                        <div class="min-h-screen flex items-center justify-center px-4">
                            <div class="text-center max-w-md w-full">
                                <div class="text-8xl mb-6">ðŸŽ‰</div>
                                <h1 class="text-3xl font-bold mb-2">Workout Complete!</h1>
                                <p class="text-text-secondary mb-8">Great job finishing your workout</p>

                                <div class="bg-secondary-bg rounded-lg p-6 mb-6">
                                    <div class="grid grid-cols-2 gap-4 text-center">
                                        <div>
                                            <div class="text-3xl font-bold text-accent">${Math.max(1, Math.round(duration / 60))}</div>
                                            <div class="text-sm text-text-secondary">Minutes</div>
                                        </div>
                                        <div>
                                            <div class="text-3xl font-bold text-success">${historyExercises.length}</div>
                                            <div class="text-sm text-text-secondary">Exercises</div>
                                        </div>
                                    </div>
                                </div>

                                <button onclick="app.navigate('home')"
                                    class="w-full bg-accent hover:bg-accent-hover py-4 rounded-lg font-bold touch-target transition-colors">
                                    Back to Home
                                </button>
                            </div>
                        </div>
                    `;
                }
            }

            confirmExitWorkout() {
                this.showCustomConfirm(
                    'Are you sure you want to exit? Your progress will be lost.',
                    async () => {
                        this.timer.stop();
                        this.activeWorkout = null;
                        this.sessionData = [];
                        this.currentExerciseIndex = 0;
                        this.currentSet = 0;
                        this.sessionStartTime = null;
                        await this.navigate('home');
                    }
                );
            }

            async deleteWorkout(workoutId) {
                this.showCustomConfirm(
                    'Are you sure you want to delete this workout?',
                    async () => {
                        await this.db.delete('workouts', workoutId);
                        await this.navigate('workouts');
                        this.showCustomAlert('Workout deleted.');
                    }
                );
            }

            async editWorkout(workoutId) {
                this.navigate('workout-builder', workoutId);
            }

            showTemplateModal() {
                const modalHTML = `
                    <div id="template-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-end justify-center z-50" onclick="if(event.target.id==='template-modal') app.closeExercisePickerModal(event)">
                        <div class="bg-secondary-bg w-full max-w-2xl rounded-t-2xl max-h-[80vh] overflow-y-auto">
                            <div class="sticky top-0 bg-secondary-bg border-b border-gray-800 p-6">
                                <div class="flex items-center justify-between">
                                    <h2 class="text-xl font-bold">Choose Template</h2>
                                    <button onclick="document.getElementById('template-modal').remove()"
                                        class="text-text-secondary hover:text-text-primary">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>

                            <div class="p-6 space-y-4">
                                <button onclick="app.navigate('workout-builder'); document.getElementById('template-modal').remove();"
                                    class="w-full bg-accent hover:bg-accent-hover p-4 rounded-lg text-left touch-target transition-colors">
                                    <div class="font-semibold mb-1">Custom Workout</div>
                                    <div class="text-sm text-text-secondary">Build your own from scratch</div>
                                </button>

                                ${WORKOUT_TEMPLATES.map((template, idx) => `
                                    <button onclick="app.createFromTemplate(${idx}); document.getElementById('template-modal').remove();"
                                        class="w-full bg-primary-bg hover:bg-opacity-80 p-4 rounded-lg text-left touch-target transition-colors border border-gray-700">
                                        <div class="font-semibold mb-1">${this.escapeHTML(template.name)}</div>
                                        <div class="text-sm text-text-secondary mb-2">${this.escapeHTML(template.description)}</div>
                                        <div class="text-xs text-accent">${template.exercises.length} exercises</div>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }

            async createFromTemplate(templateIndex) {
                const template = WORKOUT_TEMPLATES[templateIndex];
                await this.db.add('workouts', {
                    name: template.name,
                    description: template.description,
                    exercises: template.exercises
                });

                await this.navigate('workouts');
                this.showCustomAlert('Template added to your workouts.');
            }

            viewExerciseDetail(exerciseId) {
                this.navigate('exercise-detail', exerciseId);
            }

            async filterExercises(searchTerm) {
                const exercises = await this.getExercises();
                const filtered = exercises.filter(ex =>
                    ex.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    ex.category.toLowerCase().includes(searchTerm.toLowerCase())
                );

                const list = document.getElementById('exercise-list');
                if (list) {
                    list.innerHTML = this.renderExerciseList(filtered);
                }
            }

            async filterByCategory(category) {
                document.querySelectorAll('.category-filter').forEach(btn => {
                    if (btn.dataset.category === category) {
                        btn.classList.add('active', 'bg-accent');
                        btn.classList.remove('bg-gray-700');
                    } else {
                        btn.classList.remove('active', 'bg-accent');
                        btn.classList.add('bg-gray-700');
                    }
                });

                const exercises = await this.getExercises();
                const filtered = category === 'all'
                    ? exercises
                    : exercises.filter(ex => ex.category === category);

                const list = document.getElementById('exercise-list');
                if (list) {
                    list.innerHTML = this.renderExerciseList(filtered);
                }
            }

            async updateSetting(key, value) {
                const settings = await this.db.get('settings', 'general') || { key: 'general' };

                if (key === 'defaultRestTime') {
                    if (!Number.isFinite(value) || value <= 0) {
                        this.showCustomAlert('Please enter a positive number for rest time.');
                        const input = document.getElementById('default-rest-time');
                        if (input) {
                            input.value = this.defaultRestTime;
                        }
                        return;
                    }
                    this.defaultRestTime = value;
                }

                if (key === 'audioEnabled') {
                    this.timer.audioEnabled = !!value;
                }

                if (key === 'theme') {
                    this.applyTheme(value);
                }

                settings[key] = value;
                await this.db.put('settings', settings);
            }

            async exportData() {
                const data = {
                    workouts: await this.db.getAll('workouts'),
                    history: await this.db.getAll('history'),
                    exerciseHistory: await this.db.getAll('exerciseHistory'),
                    settings: await this.db.getAll('settings'),
                    exportDate: new Date().toISOString()
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `strength-training-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }

            confirmClearData() {
                this.showCustomConfirm(
                    'This will delete ALL your data including workouts, history, and settings. This cannot be undone!',
                    async () => {
                        const stores = ['workouts', 'history', 'exerciseHistory', 'settings'];
                        for (const store of stores) {
                            await this.db.clear(store);
                        }

                        await this.initializeExerciseDatabase();
                        await this.initializeSettings();

                        this.workoutBuilder = null;
                        this.builderWorkoutId = null;
                        this.exercisePickerData = [];
                        this.timer.stop();
                        this.activeWorkout = null;
                        this.sessionData = [];

                        await this.navigate('home');
                        this.showCustomAlert('All data has been cleared');
                    }
                );
            }

            showCustomAlert(message) {
                const existing = document.getElementById('custom-alert');
                if (existing) existing.remove();

                const safeMessage = this.escapeHTML(message).replace(/\n/g, '<br>');
                const modalHTML = `
                    <div id="custom-alert" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 px-4">
                        <div class="bg-secondary-bg rounded-lg p-6 max-w-sm w-full">
                            <p class="text-text-primary mb-6">${safeMessage}</p>
                            <button onclick="app.cancelCustomAlert()"
                                class="w-full bg-accent hover:bg-accent-hover py-3 rounded-lg font-semibold touch-target transition-colors">
                                OK
                            </button>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }

            cancelCustomAlert() {
                const modal = document.getElementById('custom-alert');
                if (modal) {
                    modal.remove();
                }
            }

            showCustomConfirm(message, onConfirm) {
                const existing = document.getElementById('custom-confirm');
                if (existing) existing.remove();

                this.pendingConfirmAction = onConfirm;
                this.pendingConfirmContext = this;

                const safeMessage = this.escapeHTML(message).replace(/\n/g, '<br>');

                const modalHTML = `
                    <div id="custom-confirm" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 px-4">
                        <div class="bg-secondary-bg rounded-lg p-6 max-w-sm w-full">
                            <p class="text-text-primary mb-6">${safeMessage}</p>
                            <div class="flex gap-3">
                                <button onclick="app.cancelConfirmAction()"
                                    class="flex-1 bg-gray-700 hover:bg-gray-600 py-3 rounded-lg font-semibold touch-target transition-colors">
                                    Cancel
                                </button>
                                <button onclick="app.executeConfirmAction()"
                                    class="flex-1 bg-warning hover:bg-opacity-80 py-3 rounded-lg font-semibold touch-target transition-colors">
                                    Confirm
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }

            async executeConfirmAction() {
                const modal = document.getElementById('custom-confirm');
                if (modal) {
                    modal.remove();
                }

                const callback = this.pendingConfirmAction;
                const context = this.pendingConfirmContext;

                this.pendingConfirmAction = null;
                this.pendingConfirmContext = null;

                if (typeof callback === 'function') {
                    try {
                        await callback.call(context);
                    } catch (error) {
                        console.error('Confirm action failed', error);
                        this.showCustomAlert('Something went wrong. Please try again.');
                    }
                }
            }

            cancelConfirmAction() {
                const modal = document.getElementById('custom-confirm');
                if (modal) {
                    modal.remove();
                }
                this.pendingConfirmAction = null;
                this.pendingConfirmContext = null;
            }

            closeExercisePickerModal(event) {
                if (event.target.id === 'template-modal') {
                    event.target.remove();
                }
            }

            updateBuilderField(field, value) {
                if (!this.workoutBuilder) return;
                if (field === 'name') {
                    this.workoutBuilder.name = value;
                } else if (field === 'description') {
                    this.workoutBuilder.description = value;
                }
            }

            refreshWorkoutBuilderExercises() {
                const list = document.getElementById('workout-exercises-list');
                if (!list) return;
                if (!this.workoutBuilder || !this.workoutBuilder.exercises.length) {
                    list.innerHTML = '<div class="text-center py-8 text-text-secondary">No exercises added yet</div>';
                    return;
                }
                list.innerHTML = this.workoutBuilder.exercises.map((ex, idx) => this.renderWorkoutExerciseItem(ex, idx)).join('');
            }

            showExercisePicker() {
                const modalHTML = `
                    <div id="exercise-picker-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-end justify-center z-50" onclick="if(event.target.id==='exercise-picker-modal') app.closeExercisePicker()">
                        <div class="bg-secondary-bg w-full max-w-2xl rounded-t-2xl max-h-[80vh] overflow-hidden flex flex-col">
                            <div class="sticky top-0 bg-secondary-bg border-b border-gray-800 p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h2 class="text-xl font-bold">Add Exercise</h2>
                                    <button onclick="app.closeExercisePicker()"
                                        class="text-text-secondary hover:text-text-primary">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </button>
                                </div>
                                <input type="text" placeholder="Search exercises..."
                                    oninput="app.filterExercisePicker(this.value)"
                                    class="w-full bg-primary-bg text-text-primary px-4 py-3 rounded-lg border border-gray-700 focus:border-accent outline-none text-base">
                            </div>
                            <div class="p-6 overflow-y-auto">
                                <div id="exercise-picker-list" class="space-y-3">
                                    ${this.renderExercisePickerItems(this.exerciseCache)}
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);
                this.exercisePickerData = [...this.exerciseCache];
            }

            closeExercisePicker() {
                const modal = document.getElementById('exercise-picker-modal');
                if (modal) {
                    modal.remove();
                }
                this.exercisePickerData = [];
            }

            filterExercisePicker(term = '') {
                const list = document.getElementById('exercise-picker-list');
                if (!list) return;

                const normalized = term.trim().toLowerCase();
                const filtered = !normalized
                    ? this.exercisePickerData
                    : this.exercisePickerData.filter(ex => {
                        const equipment = Array.isArray(ex.equipment) ? ex.equipment.join(' ') : '';
                        return ex.name.toLowerCase().includes(normalized) ||
                               ex.category.toLowerCase().includes(normalized) ||
                               equipment.toLowerCase().includes(normalized);
                    });

                list.innerHTML = this.renderExercisePickerItems(filtered);
            }

            renderExercisePickerItems(exercises) {
                if (!exercises.length) {
                    return `<div class="text-center py-6 text-text-secondary">No exercises match your search.</div>`;
                }
                return exercises.map(ex => `
                    <button onclick="app.addExerciseToWorkout(${ex.id})"
                        class="w-full bg-secondary-bg hover:bg-opacity-80 p-4 rounded-lg text-left touch-target transition-colors">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-semibold">${this.escapeHTML(ex.name)}</div>
                                <div class="text-xs text-text-secondary mt-1">${this.escapeHTML(ex.category)} â€¢ ${this.escapeHTML(ex.difficulty)}</div>
                                <div class="text-xs text-text-secondary mt-1">${this.formatEquipment(ex.equipment)}</div>
                            </div>
                            <svg class="w-5 h-5 text-text-secondary ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </div>
                    </button>
                `).join('');
            }

            addExerciseToWorkout(exerciseId) {
                if (!this.workoutBuilder) return;
                const exercise = this.exerciseCache.find(ex => ex.id === exerciseId);
                if (!exercise) return;

                const repRange = Array.isArray(exercise.repRange) && exercise.repRange.length === 2
                    ? [...exercise.repRange]
                    : [8, 12];

                this.workoutBuilder.exercises.push({
                    exerciseName: exercise.name,
                    sets: 3,
                    repRange: [
                        Math.max(1, parseInt(repRange[0], 10) || 8),
                        Math.max(1, parseInt(repRange[1], 10) || 12)
                    ],
                    restTime: this.defaultRestTime
                });

                this.refreshWorkoutBuilderExercises();
                this.closeExercisePicker();
            }

            removeExerciseFromWorkout(index) {
                if (!this.workoutBuilder) return;
                this.workoutBuilder.exercises.splice(index, 1);
                this.refreshWorkoutBuilderExercises();
            }

            updateExerciseSets(index, value) {
                if (!this.workoutBuilder || !this.workoutBuilder.exercises[index]) return;
                const sets = Number.isFinite(value) && value > 0 ? value : 1;
                this.workoutBuilder.exercises[index].sets = sets;
                this.refreshWorkoutBuilderExercises();
            }

            updateExerciseRepRange(index, bound, value) {
                if (!this.workoutBuilder || !this.workoutBuilder.exercises[index]) return;
                const exercise = this.workoutBuilder.exercises[index];
                if (!Array.isArray(exercise.repRange) || exercise.repRange.length !== 2) {
                    exercise.repRange = [8, 12];
                }
                const sanitized = Number.isFinite(value) && value > 0 ? value : 1;
                if (bound === 'min') {
                    exercise.repRange[0] = sanitized;
                    if (exercise.repRange[1] < sanitized) {
                        exercise.repRange[1] = sanitized;
                    }
                } else {
                    exercise.repRange[1] = Math.max(sanitized, exercise.repRange[0]);
                }
                this.refreshWorkoutBuilderExercises();
            }

            updateExerciseRest(index, value) {
                if (!this.workoutBuilder || !this.workoutBuilder.exercises[index]) return;
                const restTime = Number.isFinite(value) && value >= 0 ? value : 0;
                this.workoutBuilder.exercises[index].restTime = restTime;
                this.refreshWorkoutBuilderExercises();
            }

            async saveWorkout() {
                if (!this.workoutBuilder) return;

                const name = (this.workoutBuilder.name || '').trim();
                if (!name) {
                    this.showCustomAlert('Please enter a workout name.');
                    return;
                }

                if (!this.workoutBuilder.exercises.length) {
                    this.showCustomAlert('Add at least one exercise to save the workout.');
                    return;
                }

                const sanitizedExercises = this.workoutBuilder.exercises.map(ex => {
                    const sets = Math.max(1, parseInt(ex.sets, 10) || 1);
                    const minRep = Math.max(1, parseInt(ex.repRange?.[0], 10) || 1);
                    const maxRep = Math.max(minRep, parseInt(ex.repRange?.[1], 10) || minRep);
                    const restParsed = parseInt(ex.restTime, 10);
                    const restTime = Number.isFinite(restParsed) && restParsed >= 0 ? restParsed : this.defaultRestTime;
                    return {
                        exerciseName: ex.exerciseName || '',
                        sets,
                        repRange: [minRep, maxRep],
                        restTime
                    };
                });

                const payload = {
                    name,
                    description: (this.workoutBuilder.description || '').trim(),
                    exercises: sanitizedExercises
                };

                try {
                    if (this.builderWorkoutId !== null) {
                        payload.id = this.builderWorkoutId;
                        await this.db.put('workouts', payload);
                        this.showCustomAlert('Workout updated successfully.');
                    } else {
                        await this.db.add('workouts', payload);
                        this.showCustomAlert('Workout created successfully.');
                    }
                    this.workoutBuilder = null;
                    this.builderWorkoutId = null;
                    await this.navigate('workouts');
                } catch (error) {
                    console.error('Failed to save workout', error);
                    this.showCustomAlert('Failed to save workout. Please try again.');
                }
            }

            escapeHTML(value) {
                if (value === undefined || value === null) return '';
                return String(value).replace(/[&<>"']/g, (char) => {
                    const map = {
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        '"': '&quot;',
                        "'": '&#39;'
                    };
                    return map[char] || char;
                });
            }

            applyTheme(theme = 'dark') {
                const body = document.body;
                if (!body) return;
                if (theme === 'light') {
                    body.classList.remove('dark');
                } else {
                    body.classList.add('dark');
                }
            }

            async getExercises(forceReload = false) {
                if (!Array.isArray(this.exerciseCache)) {
                    this.exerciseCache = [];
                }
                if (forceReload || this.exerciseCache.length === 0) {
                    this.exerciseCache = await this.db.getAll('exercises');
                }
                return this.exerciseCache;
            }
        }

        const app = new App();
        app.init();
    </script>
</body>
</html>
